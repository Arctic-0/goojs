goo.Curve=function(){"use strict";function t(t){t=t||{},this.timeOffset=t.timeOffset||0}return t.prototype={toGLSL:function(){return"0.0"},numberToGLSL:function(t){return-1===(t+"").indexOf(".")?t+".0":t+""},getValueAt:function(){return 0}},t}(),goo.CurveSet=function(){"use strict";function t(t){return-1===(t+"").indexOf(".")?t+".0":t+""}function e(){this.segments=[]}return e.prototype={addSegment:function(t){this.segments.push(t),this.sort()},removeSegment:function(t){this.segments.splice(t,1)},sort:function(){this.segments=this.segments.sort(function(t,e){return t.timeOffset-e.timeOffset})},toGLSL:function(e){for(var i=this.segments,r=[],o=0;o<i.length;o++){var a=i[o],n=t(a.timeOffset),s="1.0";o<i.length-1&&(s=t(i[o+1].timeOffset)),r.push("step("+n+","+e+")*step(-"+s+",-"+e+")*"+a.toGLSL(e))}return r.join("+")},integralToGLSL:function(e){for(var i=this.segments,r=[],o=0;o<i.length;o++){var a=i[o],n=t(a.timeOffset),s="1.0";o<i.length-1&&(s=t(i[o+1].timeOffset)),r.push(a.integralToGLSL("clamp("+e+","+n+","+s+")"))}return r.join("+")},getValueAt:function(t){for(var e=this.segments,i=0;i<e.length-1;i++){var r=e[i],o=e[i+1];if(r.timeOffset<=t&&o.timeOffset>t)return this.segments[i].getValueAt(t)}return this.segments[e.length-1].getValueAt(t)},getIntegralValueAt:function(t){for(var e=this.segments,i=0,r=0;r<e.length;r++){var o=e[r],a=1;if(r<e.length-1&&(a=e[r+1].timeOffset),o.timeOffset<=t&&a>t){i+=this.segments[r].getIntegralValueAt(t);break}i+=this.segments[r].getIntegralValueAt(a)}return i}},e}(),goo.LinearCurve=function(t){"use strict";function e(e){e=e||{},t.call(this,e),this.k=void 0!==e.k?e.k:1,this.m=void 0!==e.m?e.m:0}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.toGLSL=function(t){return"("+this.numberToGLSL(this.k)+"*"+t+"+"+this.numberToGLSL(this.m)+")"},e.prototype.integralToGLSL=function(t){var e=this.numberToGLSL(this.k),i=this.numberToGLSL(this.m);return"("+e+"*"+t+"*"+t+"*0.5+"+i+"*"+t+")"},e.prototype.getValueAt=function(t){return this.k*(t-this.timeOffset)+this.m},e.prototype.getIntegralValueAt=function(t){var e=t-this.timeOffset,i=this.k,r=this.m;return.5*i*e*e+r*e},e}(goo.Curve),goo.Particle=function(t){"use strict";function e(e){this.component=e,this.lifeTime=1,this.timeScale=0,this.emitTime=0,this.active=!0,this.startPosition=new t,this.startDirection=new t,this.sortValue=0}var i=new t,r=new t;return e.prototype.getWorldPosition=function(t){var e=this.component,o=e.time-this.emitTime;return e.loop&&(o%=this.lifeTime),i.copy(this.startDirection).scale(o),r.copy(e.gravity).scale(o*o*.5),t.copy(this.startPosition).add(i).add(r),e.localSpace&&(t.applyPost(this.component.entity.transformComponent.worldTransform.rotation),t.add(this.component.entity.transformComponent.worldTransform.translation)),t},e}(goo.Vector3),goo.ParticleComponent=function(t,e,i,r,o,a,n,s,l,u,h,c,m,f,p){"use strict";function d(t){return-1===(t+"").indexOf(".")?t+".0":t+""}function g(t){t=t||{},l.apply(this,arguments),this.type=g.type,this.material=new a(T),this.material.cullState.enabled=!1,this.material.uniforms.textureTileInfo=[1,1,1,0],this.time=0,this.gravity=new e,t.gravity&&this.gravity.copy(t.gravity),this.startColor=new r(1,1,1,1),this.particles=[],this.unsortedParticles=[],this.shapeType=void 0!==t.shapeType?t.shapeType:"sphere",this.duration=void 0!==t.duration?t.duration:10,this.emitterRadius=void 0!==t.emitterRadius?t.emitterRadius:1,this.emitterExtents=void 0!==t.emitterExtents?t.emitterExtents.clone():new e(1,1,1),this.shapeRadius=void 0!==t.shapeRadius?t.shapeRadius:1,this.coneAngle=void 0!==t.coneAngle?t.coneAngle:10,this.localSpace=void 0!==t.localSpace?t.localSpace:!0,this._startSpeed=void 0!==t.startSpeed?t.startSpeed:5,this._maxParticles=void 0!==t.maxParticles?t.maxParticles:1e3,this.emissionRate=void 0!==t.emissionRate?t.emissionRate:10,this.startLifeTime=void 0!==t.startLifeTime?t.startLifeTime:5,this.renderQueue=void 0!==t.renderQueue?t.renderQueue:3010,this.alphakill=void 0!==t.alphakill?t.alphakill:0,this.loop=void 0!==t.loop?t.loop:!0,this.preWarm=void 0!==t.preWarm?t.preWarm:!0,this.blending=void 0!==t.blending?t.blending:!0,this.depthWrite=void 0!==t.depthWrite?t.depthWrite:!0,this.depthTest=void 0!==t.depthTest?t.depthTest:!0,this.textureTilesX=void 0!==t.textureTilesX?t.textureTilesX:1,this.textureTilesY=void 0!==t.textureTilesY?t.textureTilesY:1,this.startSize=void 0!==t.startSize?t.startSize:1,this.sortMode=void 0!==t.sortMode?t.sortMode:g.SORT_NONE,this.mesh=void 0!==t.mesh?t.mesh:new p(1,1,1,1),this.billboard=void 0!==t.billboard?t.billboard:!0,t.texture&&(this.texture=t.texture),this.nextEmitParticle=0}var v=new e,T={defines:{START_SCALE:"1.0"},attributes:{vertexPosition:o.POSITION,timeInfo:"TIME_INFO",startPos:"START_POS",startDir:"START_DIR",vertexUV0:o.TEXCOORD0},uniforms:{textureTileInfo:[1,1,1,0],viewMatrix:h.VIEW_MATRIX,projectionMatrix:h.PROJECTION_MATRIX,viewProjectionMatrix:h.VIEW_PROJECTION_MATRIX,worldMatrix:h.WORLD_MATRIX,particleTexture:"PARTICLE_TEXTURE",cameraPosition:h.CAMERA,time:0,gravity:[0,0,0],uColor:[1,1,1,1],alphakill:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","attribute vec4 timeInfo;","attribute vec3 startPos;","attribute vec3 startDir;","uniform vec4 textureTileInfo;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float time;","uniform vec3 gravity;","uniform vec4 uColor;","varying vec4 color;","varying vec2 coords;","vec3 getPosition(float t, vec3 pos, vec3 dir, vec3 g){","    return pos + dir * t + 0.5 * t * t * g;","}","float getScale(float t){","    return clamp(1.0 - t, 0.0, 1.0) * START_SCALE;","}","float getAngle(float t){","    return t;","}","void main(void) {","    color = uColor;","    float lifeTime = timeInfo.x;","    float active = timeInfo.y;","    float emitTime = timeInfo.w;","    float age = time * active - emitTime;","    float ageNoMod = time * active - emitTime;","    #ifdef LOOP","    age = mod(age, lifeTime);","    #endif","    float unitAge = age / lifeTime;","    float tileX = floor(mod(textureTileInfo.x * textureTileInfo.y * unitAge, textureTileInfo.x));","    float tileY = floor(mod(textureTileInfo.y * unitAge, textureTileInfo.y));","    vec2 texOffset = vec2(tileX, tileY) / textureTileInfo.xy;","    coords = vertexUV0 / textureTileInfo.xy + texOffset;","    float rotation = getAngle(age);","    float c = cos(rotation);","    float s = sin(rotation);","    mat3 spinMatrix = mat3(c, s, 0, -s, c, 0, 0, 0, 1);","    active *= step(0.0, ageNoMod) * step(0.0, age) * step(-lifeTime, -age);","    vec3 position = getPosition(age, startPos, startDir, gravity);","    #ifdef BILLBOARD","    vec2 offset = ((spinMatrix * vertexPosition)).xy * getScale(unitAge) * active;","    mat4 matPos = worldMatrix * mat4(vec4(0),vec4(0),vec4(0),vec4(position,0));","    gl_Position = viewProjectionMatrix * (worldMatrix + matPos) * vec4(0, 0, 0, 1) + projectionMatrix * vec4(offset.xy, 0, 0);","    #else","    gl_Position = viewProjectionMatrix * worldMatrix * vec4(getScale(unitAge) * active * vertexPosition + position, 1.0);","    #endif","}"].join("\n"),fshader:["uniform sampler2D particleTexture;","uniform float alphakill;","varying vec4 color;","varying vec2 coords;","void main(void){","    vec4 col = color * texture2D(particleTexture, coords);","    if (col.a <= alphakill) discard;","    gl_FragColor = col;","}"].join("\n")};g.prototype=Object.create(l.prototype),g.prototype.constructor=g,g.type="ParticleComponent",g.SORT_NONE=1,g.SORT_CAMERA_DISTANCE=2,Object.defineProperties(g.prototype,{billboard:{get:function(){return this.material.shader.hasDefine("BILLBOARD")},set:function(t){var e=this.material.shader;t?e.setDefine("BILLBOARD",!0):e.removeDefine("BILLBOARD")}},loop:{get:function(){return this.material.shader.hasDefine("LOOP")},set:function(t){t?this.material.shader.setDefine("LOOP",!0):this.material.shader.removeDefine("LOOP")}},blending:{get:function(){return this.material.blendState.blending},set:function(t){this.material.blendState.blending=t}},localSpace:{get:function(){return this.entity?!!this.entity.transformComponent.parent:this._localSpace},set:function(t){return this.entity?void(!t&&this.entity.transformComponent.parent?this.entity.transformComponent.parent.detachChild(this.entity.transformComponent):t&&!this.entity.transformComponent.parent&&this.entity.transformComponent.parent.attachChild(this.entity.transformComponent)):void(this._localSpace=t)}},depthTest:{get:function(){return this.material.depthState.enabled},set:function(t){this.material.depthState.enabled=t}},alphakill:{get:function(){return this.material.uniforms.alphakill},set:function(t){this.material.uniforms.alphakill=t}},texture:{get:function(){return this.material.getTexture("PARTICLE_TEXTURE")},set:function(t){this.material.setTexture("PARTICLE_TEXTURE",t)}},textureTilesX:{get:function(){return this.material.uniforms.textureTileInfo[0]},set:function(t){this.material.uniforms.textureTileInfo[0]=t}},textureTilesY:{get:function(){return this.material.uniforms.textureTileInfo[1]},set:function(t){this.material.uniforms.textureTileInfo[1]=t}},depthWrite:{get:function(){return this.material.depthState.write},set:function(t){this.material.depthState.write=t}},renderQueue:{get:function(){return this.material.renderQueue},set:function(t){this.material.renderQueue=t}},startSpeed:{get:function(){return this._startSpeed},set:function(t){this._startSpeed!==t&&(this._startSpeed=t,this.updateVertexData())}},startSize:{get:function(){return Number(this.material.shader.defines.START_SCALE)},set:function(t){this.material.shader.setDefine("START_SCALE",d(t))}},maxParticles:{get:function(){return this.meshData?this.meshData.vertexCount/this.mesh.vertexCount:this._maxParticles},set:function(t){t*this.mesh.vertexCount!==this.meshData.vertexCount&&(this.meshData.vertexCount=t*this.mesh.vertexCount,this.meshData.indexCount=t*this.mesh.indexCount,this.meshData.rebuildData(),this.updateParticles(),this.updateVertexData())}}}),g.prototype.init=function(){for(var t=this.maxParticles,e=0;t>e;e++){var i=new m(this);this.particles.push(i),this.unsortedParticles.push(i)}var r=o.defaultMap([o.POSITION,o.TEXCOORD0]);r.TIME_INFO=o.createAttribute(4,"Float"),r.START_POS=o.createAttribute(3,"Float"),r.START_DIR=o.createAttribute(3,"Float");var a=new o(r,t*this.mesh.vertexCount,t*this.mesh.indexCount);a.vertexData.setDataUsage("DynamicDraw"),this.meshData=a;var n=this.entity=this._entity._world.createEntity(a);n.set(new s(this.material)),n.name="ParticleSystem",n.meshRendererComponent.cullMode="Never",n.addToWorld(),this._localSpace&&this._entity.transformComponent.attachChild(n.transformComponent,!1),this.updateVertexData()};var y=new t;g.prototype.updateUniforms=function(){var t=this.material.uniforms;v.copy(this.gravity),y.copy(this.entity.transformComponent.worldTransform.rotation).invert(),v.applyPost(y),t.gravity=t.gravity||[],t.gravity[0]=v.x,t.gravity[1]=v.y,t.gravity[2]=v.z;var e=this.startColor;t.uColor=t.uColor||[],t.uColor[0]=e.x,t.uColor[1]=e.y,t.uColor[2]=e.z,t.uColor[3]=e.w,t.time=this.time},g.prototype.updateParticles=function(){for(var t=this.particles,e=this.unsortedParticles,i=this.maxParticles;t.length<i;){var r=new m(this);t.push(r),e.push(r)}for(;t.length>i;){var r=t.pop();e.splice(e.indexOf(r),1)}},g.prototype.updateVertexData=function(){var t,e,i=this.meshData,r=this.maxParticles,a=i.getAttributeBuffer(o.TEXCOORD0),n=i.getAttributeBuffer(o.POSITION),s=i.getIndexBuffer(),l=this.mesh,u=l.getIndexBuffer(),h=l.getAttributeBuffer(o.POSITION),c=l.getAttributeBuffer(o.TEXCOORD0),m=l.vertexCount;for(t=0;r>t;t++){for(var e=0;e<c.length;e++)a[t*c.length+e]=c[e];for(var e=0;e<h.length;e++)n[t*h.length+e]=h[e];for(var e=0;e<u.length;e++)s[t*u.length+e]=u[e]+t*m}i.setAttributeDataUpdated(o.TEXCOORD0),i.setAttributeDataUpdated(o.POSITION);var f=i.getAttributeBuffer("TIME_INFO");for(t=0;r>t;t++){var p=this.particles[t];for(p.active=1,p.lifeTime=this.startLifeTime,this.localSpace?(p.emitTime=this.preWarm?-t/this.emissionRate:t/this.emissionRate,p.emitTime>=this.time+this.startLifeTime?(p.active=0,p.emitTime=-9999,p.active=!1):p.active=!0):(p.active=!0,p.emitTime=-p.lifeTime),e=0;m>e;e++)f[4*m*t+4*e+0]=p.lifeTime,f[4*m*t+4*e+1]=p.active,f[4*m*t+4*e+2]=p.lifeTime,f[4*m*t+4*e+3]=p.emitTime}i.setAttributeDataUpdated("TIME_INFO");var d=i.getAttributeBuffer("START_POS"),g=i.getAttributeBuffer("START_DIR");for(t=0;r>t;t++){var p=this.particles[t],n=p.startPosition,v=p.startDirection;for(this._generateLocalPositionAndDirection(n,v),e=0;m>e;e++)d[3*m*t+3*e+0]=n.x,d[3*m*t+3*e+1]=n.y,d[3*m*t+3*e+2]=n.z,g[3*m*t+3*e+0]=v.x,g[3*m*t+3*e+1]=v.y,g[3*m*t+3*e+2]=v.z}i.setAttributeDataUpdated("START_POS"),i.setAttributeDataUpdated("START_DIR")},g.prototype._generateLocalPositionAndDirection=function(t,e){if(e.setDirect(0,this.startSpeed,0),"cube"===this.shapeType)t.setDirect(Math.random()-.5,Math.random()-.5,Math.random()-.5);else if("sphere"===this.shapeType){var i=Math.acos(2*Math.random()-1),r=2*Math.PI*Math.random(),o=this.emitterRadius;t.setDirect(o*Math.cos(r)*Math.sin(i),o*Math.cos(i),o*Math.sin(r)*Math.sin(i)),e.setDirect(Math.cos(r)*Math.sin(i),Math.cos(i),Math.sin(r)*Math.sin(i)).normalize().scale(this.startSpeed)}else if("cone"===this.shapeType){var r=2*Math.PI*Math.random(),a=Math.random(),n=this.shapeRadius*Math.random()*a;t.setDirect(n*Math.cos(r),a,n*Math.sin(r)),e.copy(t).normalize().scale(this.startSpeed),t.y-=.5}},g.prototype.emitOne=function(t,e){var i=this.meshData,r=i.getAttributeBuffer("START_POS"),o=i.getAttributeBuffer("START_DIR"),a=i.getAttributeBuffer("TIME_INFO"),n=this.nextEmitParticle=(this.nextEmitParticle+1)%this.maxParticles,s=this.unsortedParticles[n];s.emitTime=this.time,s.startPosition.copy(t),s.startDirection.copy(e),s.active=!0;for(var l=this.mesh.vertexCount,u=0;l>u;u++)a[4*l*n+4*u+3]=s.emitTime,r[3*l*n+3*u+0]=s.startPosition.x,r[3*l*n+3*u+1]=s.startPosition.y,r[3*l*n+3*u+2]=s.startPosition.z,o[3*l*n+3*u+0]=s.startDirection.x,o[3*l*n+3*u+1]=s.startDirection.y,o[3*l*n+3*u+2]=s.startDirection.z;i.setAttributeDataUpdated("START_POS"),i.setAttributeDataUpdated("START_DIR"),i.setAttributeDataUpdated("TIME_INFO")};var x=new e;g.prototype.sortParticles=function(){if(this.sortMode!==g.SORT_NONE){for(var t=this.particles,e=0;e<t.length;e++){var i=t[e];i.sortValue=-i.getWorldPosition(x).dot(f.mainCamera._direction)}for(var r=t,e=1,o=r.length;o>e;e++){for(var a=r[e],n=e-1;n>=0&&!(r[n].sortValue<=a.sortValue);n--)r[n+1]=r[n];r[n+1]=a}for(var s=this.meshData,l=s.getAttributeBuffer("START_POS"),u=s.getAttributeBuffer("START_DIR"),h=s.getAttributeBuffer("TIME_INFO"),e=0;e<t.length;e++)for(var i=t[e],c=i.emitTime,m=i.startPosition,p=i.startDirection,d=this.mesh.meshVertexCount,n=0;d>n;n++)h[4*d*e+4*n+3]=c,l[3*d*e+3*n+0]=m.x,l[3*d*e+3*n+1]=m.y,l[3*d*e+3*n+2]=m.z,u[3*d*e+3*n+0]=p.x,u[3*d*e+3*n+1]=p.y,u[3*d*e+3*n+2]=p.z;s.setAttributeDataUpdated("START_POS"),s.setAttributeDataUpdated("START_DIR"),s.setAttributeDataUpdated("TIME_INFO")}};var S=new e,P=new e;return g.prototype.process=function(t){if(this.lastTime=this.time,this.time+=t,this.updateUniforms(),this.sortParticles(),!this.localSpace)for(var e=Math.floor(this.time*this.emissionRate)-Math.floor(this.lastTime*this.emissionRate),i=0;e>i;i++)this._generateLocalPositionAndDirection(S,P),S.applyPostPoint(this._entity.transformComponent.worldTransform.matrix),P.applyPost(this._entity.transformComponent.worldTransform.rotation),this.emitOne(S,P)},g.prototype.destroy=function(){this.entity.parent&&this._entity.detachChild(this.entity),this.entity.removeFromWorld()},g.prototype.attached=function(t){this._entity=t,this._system=t._world.getSystem("PhysicsSystem"),this.init()},g.prototype.clone=function(){return new g({gravity:this.gravity,startColor:this.startColor,shapeType:this.shapeType,textureTilesX:this.textureTilesX,textureTilesY:this.textureTilesY,particles:this.particles,duration:this.duration,emitterRadius:this.emitterRadius,shapeRadius:this.shapeRadius,coneAngle:this.coneAngle,localSpace:this.localSpace,emissionRate:this.emissionRate,startLifeTime:this.startLifeTime,renderQueue:this.renderQueue,alphakill:this.alphakill,loop:this.loop})},g}(goo.Matrix3,goo.Vector3,goo.Vector,goo.Vector4,goo.MeshData,goo.Material,goo.MathUtils,goo.MeshRendererComponent,goo.Component,goo.Texture,goo.Shader,goo.Transform,goo.Particle,goo.Renderer,goo.Quad),goo.ParticleComponentHandler=function(t,e,i,r){"use strict";function o(){t.apply(this,arguments),this._type="ParticleComponent"}return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,t._registerClass("particle",o),o.prototype._prepare=function(t){return r.defaults(t,{})},o.prototype._create=function(){return new e},o.prototype._remove=function(t){t.clearComponent("ParticleComponent")},o.prototype.update=function(e,i,r){return t.prototype.update.call(this,e,i,r).then(function(t){return t?t:void 0})},o}(goo.ComponentHandler,goo.ParticleComponent,goo.rsvp,goo.ObjectUtils),goo.ParticleSystem=function(t){"use strict";function e(){t.call(this,"ParticleSystem",["ParticleComponent","TransformComponent"]),this.priority=1}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.process=function(t,e){for(var i=0;i<t.length;i++)t[i].particleComponent.process(e)},e.prototype.inserted=function(){},e.prototype.deleted=function(){},e.prototype.removedComponent=function(){},e}(goo.System),"function"==typeof require&&(define("goo/addons/particlepack/Curve",[],function(){return goo.Curve}),define("goo/addons/particlepack/CurveSet",[],function(){return goo.CurveSet}),define("goo/addons/particlepack/LinearCurve",[],function(){return goo.LinearCurve}),define("goo/addons/particlepack/Particle",[],function(){return goo.Particle}),define("goo/addons/particlepack/components/ParticleComponent",[],function(){return goo.ParticleComponent}),define("goo/addons/particlepack/handlers/ParticleComponentHandler",[],function(){return goo.ParticleComponentHandler}),define("goo/addons/particlepack/systems/ParticleSystem",[],function(){return goo.ParticleSystem}));