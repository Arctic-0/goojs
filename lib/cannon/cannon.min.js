/*
 * Copyright (c) 2014 cannon.js Authors
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.CANNON=e()}}(function(){return function e(f,n,o){function d(t,l){if(!n[t]){if(!f[t]){var u="function"==typeof require&&require;if(!l&&u)return u(t,!0);if(i)return i(t,!0);throw new Error("Cannot find module '"+t+"'")}var p=n[t]={exports:{}};f[t][0].call(p.exports,function(e){var n=f[t][1][e];return d(n?n:e)},p,p.exports,e,f,n,o)}return n[t].exports}for(var i="function"==typeof require&&require,t=0;t<o.length;t++)d(o[t]);return d}({1:[function(e,f){f.exports={name:"cannon",version:"0.6.0",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"*","grunt-browserify":"*","grunt-contrib-yuidoc":"*",browserify:"*"},dependencies:{}}},{}],2:[function(e,f){f.exports={version:e("../package.json").version,ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Compound:e("./shapes/Compound"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),ContactGenerator:e("./world/ContactGenerator"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./objects/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RigidBody:e("./objects/RigidBody"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/SAPBroadphase":10,"./constraints/Constraint":11,"./constraints/DistanceConstraint":12,"./constraints/HingeConstraint":13,"./constraints/PointToPointConstraint":14,"./equations/ContactEquation":15,"./equations/Equation":16,"./equations/FrictionEquation":17,"./equations/RotationalEquation":18,"./equations/RotationalMotorEquation":19,"./material/ContactMaterial":20,"./material/Material":21,"./math/Mat3":23,"./math/Quaternion":24,"./math/Vec3":25,"./objects/Body":26,"./objects/Particle":27,"./objects/RigidBody":28,"./objects/RigidVehicle":29,"./objects/SPHSystem":30,"./objects/Spring":31,"./shapes/Box":32,"./shapes/Compound":33,"./shapes/ConvexPolyhedron":34,"./shapes/Cylinder":35,"./shapes/Heightfield":36,"./shapes/Plane":37,"./shapes/Shape":38,"./shapes/Sphere":39,"./solver/GSSolver":40,"./solver/Solver":41,"./solver/SplitSolver":42,"./utils/EventTarget":43,"./utils/Pool":44,"./utils/Vec3Pool":47,"./world/ContactGenerator":48,"./world/World":49}],3:[function(e,f){function n(e){e=e||{},this.lowerBound=new o,e.lowerBound&&e.lowerBound.copy(this.lowerBound),this.upperBound=new o,e.upperBound&&e.upperBound.copy(this.upperBound)}{var o=e("../math/Vec3");e("../utils/Utils")}f.exports=n;new o;n.prototype.setFromPoints=function(e,f,n){var o=this.lowerBound,d=this.upperBound,i=n;e[0].copy(o),i.vmult(o,o),o.copy(d)},n.prototype.copy=function(e){e.lowerBound.copy(this.lowerBound),e.upperBound.copy(this.upperBound)},n.prototype.overlaps=function(e){var f=this.lowerBound,n=this.upperBound,o=e.lowerBound,d=e.upperBound;return(o.x<=n.x&&n.x<=d.x||f.x<=d.x&&d.x<=n.x)&&(o.y<=n.y&&n.y<=d.y||f.y<=d.y&&d.y<=n.y)}},{"../math/Vec3":25,"../utils/Utils":46}],4:[function(e,f){function n(){this.matrix=[]}f.exports=n,n.prototype.get=function(e,f){if(e=e.index,f=f.index,f>e){var n=f;f=e,e=n}return this.matrix[(e*(e+1)>>1)+f-1]},n.prototype.set=function(e,f,n){if(e=e.index,f=f.index,f>e){var o=f;f=e,e=o}this.matrix[(e*(e+1)>>1)+f-1]=n?1:0},n.prototype.reset=function(){for(var e=0,f=this.matrix.length;e!==f;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,f){function n(){this.world=null,this.useBoundingBoxes=!1}var o=e("../objects/Body"),d=e("../math/Vec3"),i=e("../math/Quaternion"),t=e("../shapes/Shape"),l=e("../shapes/Plane");f.exports=n,n.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var u=o.STATIC|o.KINEMATIC;n.prototype.needBroadphaseCollision=function(e,f){return 0===(e.collisionFilterGroup&f.collisionFilterMask)||0===(f.collisionFilterGroup&e.collisionFilterMask)?!1:(0===(e.type&u)&&!e.isSleeping()||0===(f.type&u)&&!f.isSleeping())&&(e.shape||f.shape)?e.shape instanceof l&&f.shape instanceof l?!1:!0:!1},n.prototype.intersectionTest=function(e,f,n,o){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,f,n,o):this.doBoundingSphereBroadphase(e,f,n,o)};var p=new d,s=new d,c=(new i,new d);n.prototype.doBoundingSphereBroadphase=function(e,f,n,d){var i=t.types,l=i.SPHERE|i.BOX|i.COMPOUND|i.CONVEXPOLYHEDRON,u=(i.PLANE,o.STATIC|o.KINEMATIC,p),y=s,a=c,r=e.shape,w=f.shape;if(r&&w){{r.type,w.type}f.position.vsub(e.position,u);var b=r.boundingSphereRadius+w.boundingSphereRadius;u.norm2()<b*b&&(n.push(e),d.push(f))}else if(r||w){var N=r?f:e,g=r?e:f,m=g.shape,x=m.type;if(x&l){if(x===i.SPHERE)N.position.vsub(g.position,a),m.radius*m.radius>=a.norm2()&&(n.push(N),d.push(g));else if(x===i.CONVEXPOLYHEDRON||x===i.BOX||x===i.COMPOUND){var j=m.boundingSphereRadius;N.position.vsub(g.position,a),j*j>=a.norm2()&&(n.push(N),d.push(g))}}else if(x===i.PLANE){var v=g;y.set(0,0,1),v.quaternion.vmult(y,y),N.position.vsub(v.position,a),y.dot(a)<=0&&(n.push(N),d.push(g))}}else;},n.prototype.doBoundingBoxBroadphase=function(e,f,n,o){var d=e.shape,i=f.shape;if(e.aabbNeedsUpdate&&e.computeAABB(),f.aabbNeedsUpdate&&f.computeAABB(),d&&i)e.aabbmax.x<f.aabbmin.x||e.aabbmax.y<f.aabbmin.y||e.aabbmax.z<f.aabbmin.z||e.aabbmin.x>f.aabbmax.x||e.aabbmin.y>f.aabbmax.y||e.aabbmin.z>f.aabbmax.z||(n.push(e),o.push(f));else if(d||i){var t=d?f:e,u=d?e:f;u.shape instanceof l,t.position.x<u.aabbmin.x||t.position.y<u.aabbmin.y||t.position.z<u.aabbmin.z||t.position.x>u.aabbmax.x||t.position.y>u.aabbmax.y||t.position.z>u.aabbmax.z||(n.push(e),o.push(f))}else;};var y={keys:[]},a=[],r=[];n.prototype.makePairsUnique=function(e,f){for(var n=y,o=a,d=r,i=e.length,t=0;t!==i;t++)o[t]=e[t],d[t]=f[t];e.length=0,f.length=0;for(var t=0;t!==i;t++){var l=o[t].id,u=d[t].id,p=u>l?l+","+u:u+","+l;n[p]=t,n.keys.push(p)}for(var t=0;t!==n.keys.length;t++){var p=n.keys.pop(),s=n[p];e.push(o[s]),f.push(d[s]),delete n[p]}},n.prototype.setWorld=function(){};var w=new d;n.boundingSphereCheck=function(e,f){var n=w;return e.position.vsub(f.position,n),Math.pow(e.shape.boundingSphereRadius+f.shape.boundingSphereRadius,2)>n.norm2()},n.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":24,"../math/Vec3":25,"../objects/Body":26,"../shapes/Plane":37,"../shapes/Shape":38}],6:[function(e,f){function n(e,f,n,i,t){o.apply(this),this.nx=n||10,this.ny=i||10,this.nz=t||10,this.aabbMin=e||new d(100,100,100),this.aabbMax=f||new d(-100,-100,-100);var l=this.nx*this.ny*this.nz;if(0>=l)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=l,this.binLengths.length=l;for(var u=0;l>u;u++)this.bins[u]=[],this.binLengths[u]=0}f.exports=n;var o=e("./Broadphase"),d=e("../math/Vec3"),i=e("../shapes/Shape");n.prototype=new o,n.prototype.constructor=n;{var t=new d;new d}n.prototype.collisionPairs=function(e,f,n){function o(e,f,n,o,d,i,t){var l=(e-m)*v|0,u=(f-x)*A|0,p=(n-j)*C|0,b=I((o-m)*v),N=I((d-x)*A),g=I((i-j)*C);0>l?l=0:l>=s&&(l=s-1),0>u?u=0:u>=c&&(u=c-1),0>p?p=0:p>=y&&(p=y-1),0>b?b=0:b>=s&&(b=s-1),0>N?N=0:N>=c&&(N=c-1),0>g?g=0:g>=y&&(g=y-1),l*=a,u*=r,p*=w,b*=a,N*=r,g*=w;for(var O=l;b>=O;O+=a)for(var h=u;N>=h;h+=r)for(var k=p;g>=k;k+=w){var q=O+h+k;E[q][F[q]++]=t}}for(var d=e.numObjects(),l=e.bodies,u=this.aabbMax,p=this.aabbMin,s=this.nx,c=this.ny,y=this.nz,a=c*y,r=y,w=1,b=u.x,N=u.y,g=u.z,m=p.x,x=p.y,j=p.z,v=s/(b-m),A=c/(N-x),C=y/(g-j),O=(b-m)/s,h=(N-x)/c,k=(g-j)/y,q=.5*Math.sqrt(O*O+h*h+k*k),z=i.types,B=z.SPHERE,D=z.PLANE,E=(z.BOX,z.COMPOUND,z.CONVEXPOLYHEDRON,this.bins),F=this.binLengths,G=this.bins.length,H=0;H!==G;H++)F[H]=0;for(var I=Math.ceil,p=Math.min,u=Math.max,H=0;H!==d;H++){var J=l[H],K=J.shape;switch(K.type){case B:var L=J.position.x,M=J.position.y,P=J.position.z,Q=K.radius;o(L-Q,M-Q,P-Q,L+Q,M+Q,P+Q,J);break;case D:K.worldNormalNeedsUpdate&&K.computeWorldNormal(J.quaternion);var R=K.worldNormal,S=m+.5*O-J.position.x,T=x+.5*h-J.position.y,U=j+.5*k-J.position.z,V=t;V.set(S,T,U);for(var W=0,X=0;W!==s;W++,X+=a,V.y=T,V.x+=O)for(var Y=0,Z=0;Y!==c;Y++,Z+=r,V.z=U,V.y+=h)for(var $=0,_=0;$!==y;$++,_+=w,V.z+=k)if(V.dot(R)<q){var ef=X+Z+_;E[ef][F[ef]++]=J}break;default:J.aabbNeedsUpdate&&J.computeAABB(),o(J.aabbmin.x,J.aabbmin.y,J.aabbmin.z,J.aabbmax.x,J.aabbmax.y,J.aabbmax.z,J)}}for(var H=0;H!==G;H++){var ff=F[H];if(ff>1)for(var nf=E[H],W=0;W!==ff;W++)for(var J=nf[W],Y=0;Y!==W;Y++){var of=nf[Y];this.needBroadphaseCollision(J,of)&&this.intersectionTest(J,of,f,n)}}this.makePairsUnique(f,n)}},{"../math/Vec3":25,"../shapes/Shape":38,"./Broadphase":5}],7:[function(e,f){function n(){o.apply(this)}f.exports=n;var o=e("./Broadphase"),d=e("./AABB");n.prototype=new o,n.prototype.constructor=n,n.prototype.collisionPairs=function(e,f,n){var o,d,i,t,l=e.bodies,u=l.length;for(o=0;o!==u;o++)for(d=0;d!==o;d++)i=l[o],t=l[d],this.needBroadphaseCollision(i,t)&&this.intersectionTest(i,t,f,n)};var i=new d;n.prototype.aabbQuery=function(e,f){for(var n=[],o=0;o<e.bodies.length;o++){var d=e.bodies[o];i.lowerBound=d.aabbmin,i.upperBound=d.aabbmax,d.aabb.overlaps(f)&&n.push(d)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(e,f){function n(){this.matrix={}}f.exports=n,n.prototype.get=function(e,f){if(e=e.id,f=f.id,f>e){var n=f;f=e,e=n}return e+"-"+f in this.matrix},n.prototype.set=function(e,f,n){if(e=e.id,f=f.id,f>e){var o=f;f=e,e=o}n?this.matrix[e+"-"+f]=!0:delete this.matrix[e+"-"+f]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(){}},{}],9:[function(e,f){function n(e,f){this.origin=e||new t,this.direction=f||new t,this.precision=1e-4}function o(e,f,n,o){o.vsub(f,N),n.vsub(f,p),e.vsub(f,s);var d,i,t=N.dot(N),l=N.dot(p),u=N.dot(s),c=p.dot(p),y=p.dot(s);return(d=c*u-l*y)>=0&&(i=t*y-l*u)>=0&&t*c-l*l>d+i}function d(e,f){return e.distance-f.distance}function i(e,f,n){n.vsub(e,N);var o=N.dot(f);f.mult(o,g),g.vadd(e,g);var d=n.distanceTo(g);return d}f.exports=n;var t=e("../math/Vec3"),l=e("../shapes/ConvexPolyhedron"),u=e("../shapes/Box");n.prototype.constructor=n;var p=new t,s=new t;n.prototype.intersectBody=function(e){return e.shape instanceof l?this.intersectShape(e.shape,e.quaternion,e.position,e):e.shape instanceof u?this.intersectShape(e.shape.convexPolyhedronRepresentation,e.quaternion,e.position,e):void console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")},n.prototype.intersectBodies=function(e){for(var f=[],n=0,o=e.length;o>n;n++){var i=this.intersectBody(e[n]);Array.prototype.push.apply(f,i)}return f.sort(d),f};{var c=new t,y=new t,a=new t,r=new t,w=new t,b=new t;new t,new t}n.prototype.intersectShape=function(e,f,n,d){var t,u=[];if(e instanceof l){var p=i(this.origin,this.direction,n);if(p>e.boundingSphereRadius)return u;for(var s,N,g=e.faces,m=e.vertices,x=e.faceNormals,j=0;j<g.length;j++){var v=g[j],A=x[j],C=f,O=n;if(m[v[0]].copy(c),C.vmult(c,c),c.vadd(O,c),c.vsub(this.origin,c),C.vmult(A,y),s=this.direction.dot(y),!(Math.abs(s)<this.precision)&&(N=y.dot(c)/s,!(0>N)&&0>s)){this.direction.mult(N,a),a.vadd(this.origin,a),m[v[0]].copy(r),C.vmult(r,r),O.vadd(r,r);for(var h=1;h<v.length-1;h++)if(m[v[h]].copy(w),m[v[h+1]].copy(b),C.vmult(w,w),C.vmult(b,b),O.vadd(w,w),O.vadd(b,b),o(a,r,w,b)){t={distance:this.origin.distanceTo(a),point:a.copy(),face:v,body:d},u.push(t);break}}}}return u};var N=new t,g=new t},{"../math/Vec3":25,"../shapes/Box":32,"../shapes/ConvexPolyhedron":34}],10:[function(e,f){function n(e){o.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var f=this.axisList;this._addBodyHandler=function(e){f.push(e.body)},this._removeBodyHandler=function(e){var n=f.indexOf(e.body);-1!==n&&f.splice(n,1)},e&&this.setWorld(e)}var o=(e("../shapes/Shape"),e("../collision/Broadphase"));f.exports=n,n.prototype=new o,n.prototype.setWorld=function(e){this.axisList.length=0;for(var f=0;f<e.bodies.length;f++)this.axisList.push(e.bodies[f]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e},n.insertionSortX=function(e){for(var f=1,n=e.length;n>f;f++){for(var o=e[f],d=f-1;d>=0&&!(e[d].position.x-e[d].shape.boundingSphereRadius<=o.position.x-o.shape.boundingSphereRadius);d--)e[d+1]=e[d];e[d+1]=o}return e},n.insertionSortY=function(e){for(var f=1,n=e.length;n>f;f++){for(var o=e[f],d=f-1;d>=0&&!(e[d].position.y-e[d].shape.boundingSphereRadius<=o.position.y-o.shape.boundingSphereRadius);d--)e[d+1]=e[d];e[d+1]=o}return e},n.insertionSortZ=function(e){for(var f=1,n=e.length;n>f;f++){for(var o=e[f],d=f-1;d>=0&&!(e[d].position.z-e[d].shape.boundingSphereRadius<=o.position.z-o.shape.boundingSphereRadius);d--)e[d+1]=e[d];e[d+1]=o}return e},n.prototype.collisionPairs=function(e,f,o){var d,i,t=this.axisList,l=this.axisIndex;for(0===l?n.insertionSortX(t):1===l?n.insertionSortY(t):2===l&&n.insertionSortZ(t),d=0,N=t.length;d!==N;d++){var u=t[d];for(i=d+1;N>i;i++){var p=t[i];if(this.needBroadphaseCollision(u,p)){if(!n.checkBounds(u,p,l))break;this.doBoundingSphereBroadphase(u,p,f,o)}}}},n.checkBounds=function(e,f,n){var o;0==n&&(o="x"),1==n&&(o="y"),2==n&&(o="z");var d=e.position[o],i=e.shape.boundingSphereRadius,t=f.position[o],l=f.shape.boundingSphereRadius,u=d+i,p=t-l;return u>p},n.prototype.autoDetectAxis=function(){for(var e=0,f=0,n=0,o=0,d=0,i=0,t=this.axisList,l=t.length,u=1/l,p=0;p!==l;p++){var s=t[p],c=s.position.x;e+=c,f+=c*c;var y=s.position.y;n+=y,o+=y*y;var a=s.position.z;d+=a,i+=a*a}var r=f-e*e*u,w=o-n*n*u,b=i-d*d*u;this.axisIndex=r>w?r>b?0:2:w>b?1:2}},{"../collision/Broadphase":5,"../shapes/Shape":38}],11:[function(e,f){function n(e,f,d){d=o.defaults(d,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=f,this.id=n.idCounter++,this.collideConnected=d.collideConnected,d.wakeUpBodies&&(e&&e.wakeUp(),f&&f.wakeUp())}f.exports=n;var o=e("../utils/Utils");n.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},n.idCounter=0},{"../utils/Utils":46}],12:[function(e,f){function n(e,f,n,i){o.call(this,e,f),"undefined"==typeof i&&(i=1e6);var t=this.equations=[new d(e,f)],l=t[0];l.minForce=-i,l.maxForce=i,this.update=function(){f.position.vsub(e.position,l.ni),l.ni.normalize(),l.ni.mult(.5*n,l.ri),l.ni.mult(.5*-n,l.rj)}}f.exports=n;var o=e("./Constraint"),d=e("../equations/ContactEquation");n.prototype=new o},{"../equations/ContactEquation":15,"./Constraint":11}],13:[function(e,f){function n(e,f,n){o.call(this,e,f,n);var u="undefined"!=typeof n.maxForce?n.maxForce:1e6,p=this.pivotA="undefined"!=typeof n.pivotA?n.pivotA.clone():new l,s=this.pivotB="undefined"!=typeof n.pivotB?n.pivotB.clone():new l,c=this.axisA="undefined"!=typeof n.axisA?n.axisA.clone():new l(1,0,0),y=this.axisB="undefined"!=typeof n.axisB?n.axisB.clone():new l(1,0,0),a=(this.equations=[new d(e,f),new d(e,f),new t(e,f),new t(e,f),new t(e,f)],this.getRotationalEquation1(),this.getRotationalEquation2(),this.getPointToPointEquation1()),r=this.getPointToPointEquation2(),w=this.getPointToPointEquation3();r.minForce=w.minForce=a.minForce=-u,r.maxForce=w.maxForce=a.maxForce=u;var b=p.unit(),N=s.unit(),g=this.axisA_x_pivotA=new l,m=this.axisA_x_axisA_x_pivotA=new l,x=this.axisB_x_pivotB=new l;c.cross(b,g),g.norm2()<.001&&b.tangents(g,g),c.cross(g,m),y.cross(N,x),x.norm2()<.001&&y.tangents(x,x),g.normalize(),x.normalize(),this.motorEnabled=!1,this.motorTargetVelocity=0,this.motorMinForce=-u,this.motorMaxForce=u,this.motorEquation=new i(e,f,u)}f.exports=n;var o=e("./Constraint"),d=e("../equations/RotationalEquation"),i=e("../equations/RotationalMotorEquation"),t=e("../equations/ContactEquation"),l=e("../math/Vec3");n.prototype=new o,n.prototype.enableMotor=function(){this.motorEnabled||(this.equations.push(this.motorEquation),this.motorEnabled=!0)},n.prototype.disableMotor=function(){this.motorEnabled&&(this.motorEnabled=!1,this.equations.pop())},n.prototype.update=function(){var e=this.bodyA,f=this.bodyB,n=this.equations,o=this.motorEquation,d=n[0],i=n[1],t=n[2],l=n[3],u=n[4],p=this.axisA_x_pivotA,s=this.axisA,c=this.axisB,y=this.pivotA,a=this.pivotB,r=this.axisA_x_axisA_x_pivotA,w=this.axisB_x_pivotB;t.ni.set(1,0,0),l.ni.set(0,1,0),u.ni.set(0,0,1),e.quaternion.vmult(this.pivotA,t.ri),f.quaternion.vmult(this.pivotB,t.rj),t.ri.copy(l.ri),t.rj.copy(l.rj),t.ri.copy(u.ri),t.rj.copy(u.rj),s.cross(y,p),p.norm2()<.001&&y.tangents(p,p),s.cross(p,r),c.cross(a,w),w.norm2()<.001&&c.tangents(w,w),p.normalize(),w.normalize(),e.quaternion.vmult(p,d.ni),f.quaternion.vmult(c,d.nj),e.quaternion.vmult(r,i.ni),f.quaternion.vmult(c,i.nj),this.motorEnabled&&(e.quaternion.vmult(this.axisA,o.axisA),f.quaternion.vmult(this.axisB,o.axisB),o.targetVelocity=this.motorTargetVelocity,o.maxForce=this.motorMaxForce,o.minForce=this.motorMinForce)},n.prototype.getRotationalEquation1=function(){return this.equations[0]},n.prototype.getRotationalEquation2=function(){return this.equations[1]},n.prototype.getPointToPointEquation1=function(){return this.equations[2]},n.prototype.getPointToPointEquation2=function(){return this.equations[3]},n.prototype.getPointToPointEquation3=function(){return this.equations[4]}},{"../equations/ContactEquation":15,"../equations/RotationalEquation":18,"../equations/RotationalMotorEquation":19,"../math/Vec3":25,"./Constraint":11}],14:[function(e,f){function n(e,f,n,i,t){o.call(this,e,n);var l=this.equations=[new d(e,n),new d(e,n),new d(e,n)],u=l[0],p=l[1],s=l[2];p.minForce=s.minForce=u.minForce=-t,p.maxForce=s.maxForce=u.maxForce=t,this.update=function(){n.position.vsub(e.position,u.ni),u.ni.normalize(),e.quaternion.vmult(f,u.ri),n.quaternion.vmult(i,u.rj),u.ni.tangents(p.ni,s.ni),u.ri.copy(p.ri),u.rj.copy(p.rj),u.ri.copy(s.ri),u.rj.copy(s.rj)}}f.exports=n;var o=e("./Constraint"),d=e("../equations/ContactEquation");n.prototype=new o},{"../equations/ContactEquation":15,"./Constraint":11}],15:[function(e,f){function n(e,f){o.call(this,e,f,0,1e6),this.restitution=0,this.ri=new d,this.rj=new d,this.penetrationVec=new d,this.ni=new d,this.rixn=new d,this.rjxn=new d,this.invIi=new i,this.invIj=new i,this.biInvInertiaTimesRixn=new d,this.bjInvInertiaTimesRjxn=new d}f.exports=n;var o=e("./Equation"),d=e("../math/Vec3"),i=e("../math/Mat3");n.prototype=new o,n.prototype.constructor=n;var t=new d,l=new d,u=new d;n.prototype.computeB=function(e){var f=this.a,n=this.b,o=this.bi,d=this.bj,i=this.ri,p=this.rj,s=this.rixn,c=this.rjxn,y=u,a=o.velocity,r=o.angularVelocity?o.angularVelocity:y,w=(o.force,o.tau?o.tau:y),b=d.velocity,N=d.angularVelocity?d.angularVelocity:y,g=(d.force,d.tau?d.tau:y),m=this.penetrationVec,x=(o.invMass,d.invMass,this.invIi,this.invIj,this.jacobianElementA),j=this.jacobianElementB,v=this.ni;i.cross(v,s),p.cross(v,c),v.negate(x.spatial),s.negate(x.rotational),v.copy(j.spatial),c.copy(j.rotational);var m=this.penetrationVec;m.set(0,0,0),m.vadd(d.position,m),m.vadd(p,m),m.vsub(o.position,m),m.vsub(i,m);var A=v.dot(m),C=t,O=l;o.invInertiaWorld?o.invInertiaWorld.vmult(w,C):C.set(0,0,0),d.invInertiaWorld?d.invInertiaWorld.vmult(g,O):O.set(0,0,0);var h=this.restitution+1,k=h*b.dot(v)-h*a.dot(v)+N.dot(c)-r.dot(s),q=this.computeGiMf(),z=-A*f-k*n-e*q;return z}},{"../math/Mat3":23,"../math/Vec3":25,"./Equation":16}],16:[function(e,f){function n(e,f,n,d){this.id=-1,this.minForce="undefined"==typeof n?-1e6:n,this.maxForce="undefined"==typeof d?1e6:d,this.bi=e,this.bj=f,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new o,this.jacobianElementB=new o,this.setSpookParams(1e7,4,1/60)}f.exports=n;var o=e("../math/JacobianElement"),d=e("../math/Vec3");n.prototype.constructor=n,n.prototype.setSpookParams=function(e,f,n){var o=f,d=e,i=n;this.a=4/(i*(1+4*o)),this.b=4*o/(1+4*o),this.eps=4/(i*i*d*(1+4*o))},n.prototype.computeB=function(e,f,n){var o=this.computeGW(),d=this.computeGq(),i=this.computeGiMf();return-d*e-o*f-i*n},n.prototype.computeGq=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.position,i=o.position;return e.spatial.dot(d)+f.spatial.dot(i)};var i=new d;n.prototype.computeGW=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.velocity,t=o.velocity,l=n.angularVelocity||i,u=o.angularVelocity||i;return e.multiplyVectors(d,l)+f.multiplyVectors(t,u)},n.prototype.computeGWlambda=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.vlambda,t=o.vlambda,l=n.wlambda||i,u=o.wlambda||i;return e.multiplyVectors(d,l)+f.multiplyVectors(t,u)};var t=new d,l=new d,u=new d,p=new d;n.prototype.computeGiMf=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.force,i=n.tau,s=o.force,c=o.tau,y=n.invMassSolve,a=o.invMassSolve;return n.invInertiaWorldSolve?n.invInertiaWorldSolve.vmult(i,u):u.set(0,0,0),o.invInertiaWorldSolve?o.invInertiaWorldSolve.vmult(c,p):p.set(0,0,0),d.mult(y,t),s.mult(a,l),e.multiplyVectors(t,u)+f.multiplyVectors(l,p)};var s=new d;n.prototype.computeGiMGt=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.invMassSolve,i=o.invMassSolve,t=n.invInertiaWorldSolve,l=o.invInertiaWorldSolve,u=d+i;return t&&(t.vmult(e.rotational,s),u+=s.dot(e.rotational)),l&&(l.vmult(f.rotational,s),u+=s.dot(f.rotational)),u};{var c=new d;new d,new d,new d,new d,new d}n.prototype.addToWlambda=function(e){var f=this.jacobianElementA,n=this.jacobianElementB,o=this.bi,d=this.bj,i=c;f.spatial.mult(o.invMassSolve*e,i),o.vlambda.vadd(i,o.vlambda),n.spatial.mult(d.invMassSolve*e,i),d.vlambda.vadd(i,d.vlambda),o.invInertiaWorldSolve&&(o.invInertiaWorldSolve.vmult(f.rotational,i),i.mult(e,i),o.wlambda.vadd(i,o.wlambda)),d.invInertiaWorldSolve&&(d.invInertiaWorldSolve.vmult(n.rotational,i),i.mult(e,i),d.wlambda.vadd(i,d.wlambda))},n.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":22,"../math/Vec3":25}],17:[function(e,f){function n(e,f,n){o.call(this,e,f,-n,n),this.ri=new d,this.rj=new d,this.t=new d,this.rixt=new d,this.rjxt=new d,this.wixri=new d,this.wjxrj=new d,this.invIi=new i,this.invIj=new i,this.relVel=new d,this.relForce=new d,this.biInvInertiaTimesRixt=new d,this.bjInvInertiaTimesRjxt=new d}f.exports=n;var o=e("./Equation"),d=e("../math/Vec3"),i=e("../math/Mat3");n.prototype=new o,n.prototype.constructor=n;var t=new d,l=new d,u=new d;n.prototype.computeB=function(e){var f=(this.a,this.b),n=this.bi,o=this.bj,d=this.ri,i=this.rj,p=this.rixt,s=this.rjxt,c=this.wixri,y=this.wjxrj,a=u,r=(n.velocity,n.angularVelocity?n.angularVelocity:a),w=(n.force,n.tau?n.tau:a),b=(o.velocity,o.angularVelocity?o.angularVelocity:a),N=(o.force,o.tau?o.tau:a),g=(this.relVel,this.relForce,n.invMass,o.invMass,this.invIi,this.invIj,this.t),m=t,x=l;d.cross(g,p),i.cross(g,s),r.cross(d,c),b.cross(i,y);var j=this.jacobianElementA,v=this.jacobianElementB;g.negate(j.spatial),p.negate(j.rotational),g.copy(v.spatial),s.copy(v.rotational),n.invInertiaWorld?n.invInertiaWorld.vmult(w,m):m.set(0,0,0),o.invInertiaWorld?o.invInertiaWorld.vmult(N,x):x.set(0,0,0);var A=this.computeGW();GiMf=this.computeGiMf();var C=-A*f-e*GiMf;return C}},{"../math/Mat3":23,"../math/Vec3":25,"./Equation":16}],18:[function(e,f){function n(e,f){i.call(this,e,f,-1e6,1e6),this.ni=new o,this.nj=new o,this.nixnj=new o,this.njxni=new o,this.invIi=new d,this.invIj=new d,this.relVel=new o,this.relForce=new o}f.exports=n;var o=e("../math/Vec3"),d=e("../math/Mat3"),i=e("./Equation");n.prototype=new i,n.prototype.constructor=n;var t=new o;n.prototype.computeB=function(e){{var f=this.a,n=this.b,o=this.bi,d=this.bj,i=this.ni,l=this.nj,u=this.nixnj,p=this.njxni,s=(o.velocity,o.angularVelocity?o.angularVelocity:t,o.force,o.tau?o.tau:t,d.velocity,d.angularVelocity?d.angularVelocity:t,d.force,d.tau?d.tau:t,o.invMass,d.invMass,this.jacobianElementA),c=this.jacobianElementB;this.invIi,this.invIj}i.cross(l,u),l.cross(i,p),p.copy(s.rotational),u.copy(c.rotational);var y=-i.dot(l),a=this.computeGW(),r=this.computeGiMf(),w=-y*f-a*n-e*r;return w}},{"../math/Mat3":23,"../math/Vec3":25,"./Equation":16}],19:[function(e,f){function n(e,f,n){n=n||1e6,i.call(this,e,f,-n,n),this.axisA=new o,this.axisB=new o,this.invIi=new d,this.invIj=new d,this.targetVelocity=0}f.exports=n;var o=e("../math/Vec3"),d=e("../math/Mat3"),i=e("./Equation");n.prototype=new i,n.prototype.constructor=n;var t=new o;n.prototype.computeB=function(e){{var f=(this.a,this.b),n=this.bi,o=this.bj,d=this.axisA,i=this.axisB,l=(n.velocity,n.angularVelocity?n.angularVelocity:t,n.force,n.tau?n.tau:t,o.velocity,o.angularVelocity?o.angularVelocity:t,o.force,o.tau?o.tau:t,this.jacobianElementA),u=this.jacobianElementB;n.invMass,o.invMass}d.copy(l.rotational),i.negate(u.rotational);var p=this.computeGW()-this.targetVelocity,s=this.computeGiMf(),c=-p*f-e*s;return c}},{"../math/Mat3":23,"../math/Vec3":25,"./Equation":16}],20:[function(e,f){function n(e,f,d){d=o.defaults(d,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=n.idCounter++,this.materials=[e,f],this.friction=d.friction,this.restitution=d.restitution,this.contactEquationStiffness=d.contactEquationStiffness,this.contactEquationRelaxation=d.contactEquationRelaxation,this.frictionEquationStiffness=d.frictionEquationStiffness,this.frictionEquationRelaxation=d.frictionEquationRelaxation}var o=e("../utils/Utils");f.exports=n,n.idCounter=0},{"../utils/Utils":46}],21:[function(e,f){function n(e){this.name=e,this.id=n.idCounter++}f.exports=n,n.idCounter=0},{}],22:[function(e,f){function n(){this.spatial=new o,this.rotational=new o}f.exports=n;var o=e("./Vec3");n.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},n.prototype.multiplyVectors=function(e,f){return e.dot(this.spatial)+f.dot(this.rotational)}},{"./Vec3":25}],23:[function(e,f){function n(e){this.elements=e?e:[0,0,0,0,0,0,0,0,0]}f.exports=n;var o=e("./Vec3");n.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},n.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},n.prototype.setTrace=function(e){var f=this.elements;f[0]=e.x,f[4]=e.y,f[8]=e.z},n.prototype.getTrace=function(e){var e=e||new o,f=this.elements;e.x=f[0],e.y=f[4],e.z=f[8]},n.prototype.vmult=function(e,f){f=f||new o;var n=this.elements,d=e.x,i=e.y,t=e.z;return f.x=n[0]*d+n[1]*i+n[2]*t,f.y=n[3]*d+n[4]*i+n[5]*t,f.z=n[6]*d+n[7]*i+n[8]*t,f},n.prototype.smult=function(e){for(var f=0;f<this.elements.length;f++)this.elements[f]*=e},n.prototype.mmult=function(e,f){for(var o=f||new n,d=0;3>d;d++)for(var i=0;3>i;i++){for(var t=0,l=0;3>l;l++)t+=e.elements[d+3*l]*this.elements[l+3*i];o.elements[d+3*i]=t}return o},n.prototype.scale=function(e,f){f=f||new n;for(var o=this.elements,d=f.elements,i=0;3!==i;i++)d[3*i+0]=e.x*o[3*i+0],d[3*i+1]=e.y*o[3*i+1],d[3*i+2]=e.z*o[3*i+2];return f},n.prototype.solve=function(e,f){f=f||new o;for(var n=3,d=4,i=[],t=0;n*d>t;t++)i.push(0);var t,l;for(t=0;3>t;t++)for(l=0;3>l;l++)i[t+d*l]=this.elements[t+3*l];i[3]=e.x,i[7]=e.y,i[11]=e.z;var u,p,s=3,c=s,y=4;do{if(t=c-s,0===i[t+d*t])for(l=t+1;c>l;l++)if(0!==i[t+d*l]){u=y;do p=y-u,i[p+d*t]+=i[p+d*l];while(--u);break}if(0!==i[t+d*t])for(l=t+1;c>l;l++){var a=i[t+d*l]/i[t+d*t];u=y;do p=y-u,i[p+d*l]=t>=p?0:i[p+d*l]-i[p+d*t]*a;while(--u)}}while(--s);if(f.z=i[2*d+3]/i[2*d+2],f.y=(i[1*d+3]-i[1*d+2]*f.z)/i[1*d+1],f.x=(i[0*d+3]-i[0*d+2]*f.z-i[0*d+1]*f.y)/i[0*d+0],isNaN(f.x)||isNaN(f.y)||isNaN(f.z)||1/0===f.x||1/0===f.y||1/0===f.z)throw"Could not solve equation! Got x=["+f.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return f},n.prototype.e=function(e,f,n){return void 0===n?this.elements[f+3*e]:void(this.elements[f+3*e]=n)},n.prototype.copy=function(e){e=e||new n;for(var f=0;f<this.elements.length;f++)e.elements[f]=this.elements[f];return e},n.prototype.toString=function(){for(var e="",f=",",n=0;9>n;n++)e+=this.elements[n]+f;return e},n.prototype.reverse=function(e){e=e||new n;for(var f=3,o=6,d=[],i=0;f*o>i;i++)d.push(0);var i,t;for(i=0;3>i;i++)for(t=0;3>t;t++)d[i+o*t]=this.elements[i+3*t];d[3]=1,d[9]=0,d[15]=0,d[4]=0,d[10]=1,d[16]=0,d[5]=0,d[11]=0,d[17]=1;var l,u,p=3,s=p,c=o;do{if(i=s-p,0===d[i+o*i])for(t=i+1;s>t;t++)if(0!==d[i+o*t]){l=c;do u=c-l,d[u+o*i]+=d[u+o*t];while(--l);break}if(0!==d[i+o*i])for(t=i+1;s>t;t++){var y=d[i+o*t]/d[i+o*i];l=c;do u=c-l,d[u+o*t]=i>=u?0:d[u+o*t]-d[u+o*i]*y;while(--l)}}while(--p);i=2;do{t=i-1;do{var y=d[i+o*t]/d[i+o*i];l=o;do u=o-l,d[u+o*t]=d[u+o*t]-d[u+o*i]*y;while(--l)}while(t--)}while(--i);i=2;do{var y=1/d[i+o*i];l=o;do u=o-l,d[u+o*i]=d[u+o*i]*y;while(--l)}while(i--);i=2;do{t=2;do{if(u=d[f+t+o*i],isNaN(u)||1/0===u)throw"Could not reverse! A=["+this.toString()+"]";e.e(i,t,u)}while(t--)}while(i--);return e},n.prototype.setRotationFromQuaternion=function(e){var f=e.x,n=e.y,o=e.z,d=e.w,i=f+f,t=n+n,l=o+o,u=f*i,p=f*t,s=f*l,c=n*t,y=n*l,a=o*l,r=d*i,w=d*t,b=d*l,N=this.elements;return N[0]=1-(c+a),N[1]=p-b,N[2]=s+w,N[3]=p+b,N[4]=1-(u+a),N[5]=y-r,N[6]=s-w,N[7]=y+r,N[8]=1-(u+c),this},n.prototype.transpose=function(e){e=e||new n;for(var f=e.elements,o=this.elements,d=0;3!==d;d++)for(var i=0;3!==i;i++)f[3*d+i]=o[3*i+d];return e}},{"./Vec3":25}],24:[function(e,f){function n(e,f,n,o){this.x=void 0!==e?e:0,this.y=void 0!==f?f:0,this.z=void 0!==n?n:0,this.w=void 0!==o?o:1}f.exports=n;var o=e("./Vec3");n.prototype.set=function(e,f,n,o){this.x=e,this.y=f,this.z=n,this.w=o},n.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},n.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},n.prototype.setFromAxisAngle=function(e,f){var n=Math.sin(.5*f);
this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(.5*f)},n.prototype.toAxisAngle=function(e){e=e||new o,this.normalize();var f=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return.001>n?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,f]};var d=new o,i=new o;n.prototype.setFromVectors=function(e,f){if(e.isAntiparallelTo(f)){var n=d,o=i;e.tangents(n,o),this.setFromAxisAngle(n,Math.PI)}else{var t=e.cross(f);this.x=t.x,this.y=t.y,this.z=t.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(f.norm(),2))+e.dot(f),this.normalize()}};var t=new o,l=new o,u=new o;n.prototype.mult=function(e,f){f=f||new n;var o=this.w,d=t,i=l,p=u;return d.set(this.x,this.y,this.z),i.set(e.x,e.y,e.z),f.w=o*e.w-d.dot(i),d.cross(i,p),f.x=o*i.x+e.w*d.x+p.x,f.y=o*i.y+e.w*d.y+p.y,f.z=o*i.z+e.w*d.z+p.z,f},n.prototype.inverse=function(e){var f=this.x,o=this.y,d=this.z,i=this.w;e=e||new n,this.conjugate(e);var t=1/(f*f+o*o+d*d+i*i);return e.x*=t,e.y*=t,e.z*=t,e.w*=t,e},n.prototype.conjugate=function(e){return e=e||new n,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},n.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},n.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e)},n.prototype.vmult=function(e,f){f=f||new o;var n=e.x,d=e.y,i=e.z,t=this.x,l=this.y,u=this.z,p=this.w,s=p*n+l*i-u*d,c=p*d+u*n-t*i,y=p*i+t*d-l*n,a=-t*n-l*d-u*i;return f.x=s*p+a*-t+c*-u-y*-l,f.y=c*p+a*-l+y*-t-s*-u,f.z=y*p+a*-u+s*-l-c*-t,f},n.prototype.copy=function(e){e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w},n.prototype.toEuler=function(e,f){f=f||"YZX";var n,o,d,i=this.x,t=this.y,l=this.z,u=this.w;switch(f){case"YZX":var p=i*t+l*u;if(p>.499&&(n=2*Math.atan2(i,u),o=Math.PI/2,d=0),-.499>p&&(n=-2*Math.atan2(i,u),o=-Math.PI/2,d=0),isNaN(n)){var s=i*i,c=t*t,y=l*l;n=Math.atan2(2*t*u-2*i*l,1-2*c-2*y),o=Math.asin(2*p),d=Math.atan2(2*i*u-2*t*l,1-2*s-2*y)}break;default:throw new Error("Euler order "+f+" not supported yet.")}e.y=n,e.z=o,e.x=d},n.prototype.setFromEuler=function(e,f,n,o){o=o||"XYZ";var d=Math.cos(e/2),i=Math.cos(f/2),t=Math.cos(n/2),l=Math.sin(e/2),u=Math.sin(f/2),p=Math.sin(n/2);return"XYZ"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t-l*u*p):"YXZ"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t+l*u*p):"ZXY"===o?(this.x=l*i*t-d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t-l*u*p):"ZYX"===o?(this.x=l*i*t-d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t+l*u*p):"YZX"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t-l*u*p):"XZY"===o&&(this.x=l*i*t-d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t+l*u*p),this},n.prototype.clone=function(){return new n(this.x,this.y,this.z,this.w)}},{"./Vec3":25}],25:[function(e,f){function n(e,f,n){this.x=e||0,this.y=f||0,this.z=n||0}f.exports=n;var o=e("./Mat3");n.ZERO=new n(0,0,0),n.prototype.cross=function(e,f){var o=e.x,d=e.y,i=e.z,t=this.x,l=this.y,u=this.z;return f=f||new n,f.x=l*i-u*d,f.y=u*o-t*i,f.z=t*d-l*o,f},n.prototype.set=function(e,f,n){return this.x=e,this.y=f,this.z=n,this},n.prototype.setZero=function(){this.x=this.y=this.z=0},n.prototype.vadd=function(e,f){return f?(f.x=e.x+this.x,f.y=e.y+this.y,f.z=e.z+this.z,void 0):new n(this.x+e.x,this.y+e.y,this.z+e.z)},n.prototype.vsub=function(e,f){return f?(f.x=this.x-e.x,f.y=this.y-e.y,f.z=this.z-e.z,void 0):new n(this.x-e.x,this.y-e.y,this.z-e.z)},n.prototype.crossmat=function(){return new o([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},n.prototype.normalize=function(){var e=this.x,f=this.y,n=this.z,o=Math.sqrt(e*e+f*f+n*n);if(o>0){var d=1/o;this.x*=d,this.y*=d,this.z*=d}else this.x=0,this.y=0,this.z=0;return o},n.prototype.unit=function(e){e=e||new n;var f=this.x,o=this.y,d=this.z,i=Math.sqrt(f*f+o*o+d*d);return i>0?(i=1/i,e.x=f*i,e.y=o*i,e.z=d*i):(e.x=1,e.y=0,e.z=0),e},n.prototype.norm=function(){var e=this.x,f=this.y,n=this.z;return Math.sqrt(e*e+f*f+n*n)},n.prototype.norm2=function(){return this.dot(this)},n.prototype.distanceTo=function(e){var f=this.x,n=this.y,o=this.z,d=e.x,i=e.y,t=e.z;return Math.sqrt((d-f)*(d-f)+(i-n)*(i-n)+(t-o)*(t-o))},n.prototype.mult=function(e,f){f=f||new n;var o=this.x,d=this.y,i=this.z;return f.x=e*o,f.y=e*d,f.z=e*i,f},n.prototype.scale=n.prototype.mult,n.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},n.prototype.negate=function(e){return e=e||new n,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var d=new n,i=new n;n.prototype.tangents=function(e,f){var n=this.norm();if(n>0){var o=d,t=1/n;o.set(this.x*t,this.y*t,this.z*t);var l=i;Math.abs(o.x)<.9?(l.set(1,0,0),o.cross(l,e)):(l.set(0,1,0),o.cross(l,e)),o.cross(e,f)}else e.set(1,0,0).normalize(),f.set(0,1,0).normalize()},n.prototype.toString=function(){return this.x+","+this.y+","+this.z},n.prototype.toArray=function(){return[this.x,this.y,this.z]},n.prototype.copy=function(e){return e=e||new n,e.x=this.x,e.y=this.y,e.z=this.z,e},n.prototype.lerp=function(e,f,n){var o=this.x,d=this.y,i=this.z;n.x=o+(e.x-o)*f,n.y=d+(e.y-d)*f,n.z=i+(e.z-i)*f},n.prototype.almostEquals=function(e,f){return void 0===f&&(f=1e-6),Math.abs(this.x-e.x)>f||Math.abs(this.y-e.y)>f||Math.abs(this.z-e.z)>f?!1:!0},n.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e?!1:!0};var t=new n;n.prototype.isAntiparallelTo=function(e,f){return this.negate(t),t.almostEquals(e,f)},n.prototype.clone=function(){return new n(this.x,this.y,this.z)}},{"./Mat3":23}],26:[function(e,f){function n(){o.apply(this),this.id=n.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new d,this.collisionFilterGroup=1,this.collisionFilterMask=1,this.collisionResponse=!0}f.exports=n;var o=e("../utils/EventTarget"),d=e("../math/Vec3");n.prototype=new o,n.DYNAMIC=1,n.STATIC=2,n.KINEMATIC=4,n.AWAKE=0,n.SLEEPY=1,n.SLEEPING=2,n.idCounter=0},{"../math/Vec3":25,"../utils/EventTarget":43}],27:[function(e,f){function n(e,f){if("number"!=typeof e)throw new Error("Argument 1 (mass) must be a number.");if("undefined"!=typeof f&&!(f instanceof i))throw new Error("Argument 2 (material) must be an instance of Material.");d.call(this,"particle"),this.position=new o,this.previousPosition=new o,this.initPosition=new o,this.velocity=new o,this.initVelocity=new o,this.force=new o,this.mass=e,this.invMass=e>0?1/e:0,this.material=f,this.linearDamping=.01,this.type=0>=e?d.STATIC:d.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1}f.exports=n;var o=(e("../shapes/Shape"),e("../math/Vec3")),d=(e("../math/Quaternion"),e("./Body")),i=e("../material/Material");n.prototype=new d,n.prototype.constructor=n,n.prototype.isAwake=function(){return this.sleepState===d.AWAKE},n.prototype.isSleepy=function(){return this.sleepState===d.SLEEPY},n.prototype.isSleeping=function(){return this.sleepState===d.SLEEPING},n.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,e===d.SLEEPING&&this.dispatchEvent({type:"wakeup"})},n.prototype.sleep=function(){this.sleepState=d.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},n.sleepyEvent={type:"sleepy"},n.sleepEvent={type:"sleep"},n.prototype.sleepTick=function(e){if(this.allowSleep){var f=this.sleepState,o=this.velocity.norm2(),i=Math.pow(this.sleepSpeedLimit,2);f===d.AWAKE&&i>o?(this.sleepState=d.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(n.sleepyEvent)):f===d.SLEEPY&&o>i?this.wakeUp():f===d.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(n.sleepEvent))}}},{"../material/Material":21,"../math/Quaternion":24,"../math/Vec3":25,"../shapes/Shape":38,"./Body":26}],28:[function(e,f){function n(e,f,n){if("number"!=typeof e)throw new Error("Argument 1 (mass) must be a number.");if("undefined"!=typeof n&&!(n instanceof u))throw new Error("Argument 3 (material) must be an instance of Material.");t.call(this,e,n);this.tau=new o,this.quaternion=new i,this.initQuaternion=new i,this.angularVelocity=new o,this.initAngularVelocity=new o,this.interpolatedPosition=new o,this.interpolatedQuaternion=new i,this.shape=f,this.inertia=new o,this.invInertia=new o,this.invInertiaWorld=new d,this.invMassSolve=0,this.invInertiaSolve=new o,this.invInertiaWorldSolve=new d,this.fixedRotation=!1,this.angularDamping=.01,this.aabbmin=new o,this.aabbmax=new o,this.aabbNeedsUpdate=!0,this.wlambda=new o,this.updateMassProperties()}f.exports=n;var o=(e("../shapes/Shape"),e("../math/Vec3")),d=e("../math/Mat3"),i=e("../math/Quaternion"),t=e("./Particle"),l=e("./Body"),u=e("../material/Material");n.prototype=new t(0),n.prototype.constructor=n,n.prototype.updateSolveMassProperties=function(){this.sleepState===l.SLEEPING||this.type===l.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertia.copy(this.invInertiaSolve),this.invInertiaWorld.copy(this.invInertiaWorldSolve))},n.prototype.pointToLocalFrame=function(e,f){var f=f||new o;return e.vsub(this.position,f),this.quaternion.conjugate().vmult(f,f),f},n.prototype.pointToWorldFrame=function(e,f){var f=f||new o;return this.quaternion.vmult(e,f),f.vadd(this.position,f),f},n.prototype.vectorToWorldFrame=function(e,f){var f=f||new o;return this.quaternion.vmult(e,f),f},n.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax),this.aabbNeedsUpdate=!1};{var p=new d,s=new d;new d}n.prototype.updateInertiaWorld=function(e){var f=this.invInertia;if(f.x!=f.y||f.y!=f.z||e){var n=p,o=s;n.setRotationFromQuaternion(this.quaternion),n.transpose(o),n.scale(f,n),n.mmult(o,this.invInertiaWorld)}else;};var c=new o,y=new o;n.prototype.applyForce=function(e,f){var n=c;f.vsub(this.position,n);var o=y;n.cross(e,o),this.force.vadd(e,this.force),this.tau.vadd(o,this.tau)};var a=new o,r=new o,w=new o;n.prototype.applyImpulse=function(e,f){var n=a;f.vsub(this.position,n);var o=r;e.copy(o),o.mult(this.invMass,o),this.velocity.vadd(o,this.velocity);var d=w;n.cross(e,d),this.invInertiaWorld.vmult(d,d),this.angularVelocity.vadd(d,this.angularVelocity)},n.prototype.updateMassProperties=function(){this.invMass=this.mass>0?1/this.mass:0,this.shape.calculateLocalInertia(this.mass,this.inertia);var e=this.inertia,f=this.fixedRotation;this.invInertia.set(e.x>0&&!f?1/e.x:0,e.y>0&&!f?1/e.y:0,e.z>0&&!f?1/e.z:0),this.updateInertiaWorld(!0)}},{"../material/Material":21,"../math/Mat3":23,"../math/Quaternion":24,"../math/Vec3":25,"../shapes/Shape":38,"./Body":26,"./Particle":27}],29:[function(e,f){function n(e){if(this.wheelBodies=[],this.coordinateSystem="undefined"==typeof e.coordinateSystem?new t(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var f=new i(new t(5,2,.5));this.chassisBody=new o(1,f)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var o=e("./RigidBody"),d=e("../shapes/Sphere"),i=e("../shapes/Box"),t=e("../math/Vec3"),l=e("../constraints/HingeConstraint");f.exports=n,n.prototype.addWheel=function(e){e=e||{};var f=e.body;f||(f=new o(1,new d(1.2))),this.wheelBodies.push(f),this.wheelForces.push(0);var n=(new t,e.position||new t),i=new t;this.chassisBody.pointToLocalFrame(n,i),f.position.set(i.x,i.y,i.z);var u=e.axis||new t(0,1,0);this.wheelAxes.push(u.clone());var p=new l(this.chassisBody,f,{pivotA:n,axisA:u,pivotB:t.ZERO,axisB:u,collideConnected:!1});return this.constraints.push(p),this.wheelBodies.length-1},n.prototype.setSteeringValue=function(e,f){var n=this.wheelAxes[f],o=Math.cos(e),d=Math.sin(e),i=n.x,t=n.y;this.constraints[f].axisA.set(o*i-d*t,d*i+o*t,0)},n.prototype.setMotorSpeed=function(e,f){var n=this.constraints[f];n.enableMotor(),n.motorTargetVelocity=e},n.prototype.disableMotor=function(e){var f=this.constraints[e];f.disableMotor()};var u=new t;n.prototype.setWheelForce=function(e,f){this.wheelForces[f]=e},n.prototype.applyWheelForce=function(e,f){var n=this.wheelAxes[f],o=this.wheelBodies[f],d=o.tau;n.scale(e,u),o.vectorToWorldFrame(u,u),d.vadd(u,d)},n.prototype.addToWorld=function(e){for(var f=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),o=0;o<n.length;o++)e.add(n[o]);for(var o=0;o<f.length;o++)e.addConstraint(f[o]);e.addEventListener("preStep",this._update.bind(this))},n.prototype._update=function(){for(var e=this.wheelForces,f=0;f<e.length;f++)this.applyWheelForce(e[f],f)},n.prototype.removeFromWorld=function(e){for(var f=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),o=0;o<n.length;o++)e.remove(n[o]);for(var o=0;o<f.length;o++)e.removeConstraint(f[o])};var p=new t;n.prototype.getWheelSpeed=function(e){var f=this.wheelAxes[e],n=this.wheelBodies[e],o=n.angularVelocity;return this.chassisBody.vectorToWorldFrame(f,p),o.dot(p)}},{"../constraints/HingeConstraint":13,"../math/Vec3":25,"../shapes/Box":32,"../shapes/Sphere":39,"./RigidBody":28}],30:[function(e,f){function n(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}f.exports=n;{var o=(e("../shapes/Shape"),e("../math/Vec3"));e("../math/Quaternion"),e("./Particle"),e("../material/Material")}n.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},n.prototype.remove=function(e){var f=this.particles.indexOf(e);-1!==f&&(this.particles.splice(f,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var d=new o;n.prototype.getNeighbors=function(e,f){for(var n=this.particles.length,o=e.id,i=this.smoothingRadius*this.smoothingRadius,t=d,l=0;l!==n;l++){var u=this.particles[l];u.position.vsub(e.position,t),o!==u.id&&t.norm2()<i&&f.push(u)}};var i=new o,t=new o,l=new o,u=new o,p=new o,s=new o;n.prototype.update=function(){for(var e=this.particles.length,f=i,n=this.speedOfSound,o=this.eps,d=0;d!==e;d++){var c=this.particles[d],y=this.neighbors[d];y.length=0,this.getNeighbors(c,y),y.push(this.particles[d]);for(var a=y.length,r=0,w=0;w!==a;w++){c.position.vsub(y[w].position,f);var b=f.norm(),N=this.w(b);r+=y[w].mass*N}this.densities[d]=r,this.pressures[d]=n*n*(this.densities[d]-this.density)}for(var g=t,m=l,x=u,j=p,v=s,d=0;d!==e;d++){var A=this.particles[d];g.set(0,0,0),m.set(0,0,0);for(var C,O,y=this.neighbors[d],a=y.length,w=0;w!==a;w++){var h=y[w];A.position.vsub(h.position,j);var k=j.norm();C=-h.mass*(this.pressures[d]/(this.densities[d]*this.densities[d]+o)+this.pressures[w]/(this.densities[w]*this.densities[w]+o)),this.gradw(j,x),x.mult(C,x),g.vadd(x,g),h.velocity.vsub(A.velocity,v),v.mult(1/(1e-4+this.densities[d]*this.densities[w])*this.viscosity*h.mass,v),O=this.nablaw(k),v.mult(O,v),m.vadd(v,m)}m.mult(A.mass,m),g.mult(A.mass,g),A.force.vadd(m,A.force),A.force.vadd(g,A.force)}},n.prototype.w=function(e){var f=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(f,9))*Math.pow(f*f-e*e,3)},n.prototype.gradw=function(e,f){var n=e.norm(),o=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(o,9))*Math.pow(o*o-n*n,2),f)},n.prototype.nablaw=function(e){var f=this.smoothingRadius,n=945/(32*Math.PI*Math.pow(f,9))*(f*f-e*e)*(7*e*e-3*f*f);return n}},{"../material/Material":21,"../math/Quaternion":24,"../math/Vec3":25,"../shapes/Shape":38,"./Particle":27}],31:[function(e,f){function n(e,f,n){n=n||{},this.restLength="number"==typeof n.restLength?n.restLength:1,this.stiffness=n.stiffness||100,this.damping=n.damping||1,this.bodyA=e,this.bodyB=f,this.localAnchorA=new o,this.localAnchorB=new o,n.localAnchorA&&this.localAnchorA.set(n.localAnchorA.x,n.localAnchorA.y,n.localAnchorA.z),n.localAnchorB&&this.localAnchorB.set(n.localAnchorB.x,n.localAnchorB.y,n.localAnchorB.z),n.worldAnchorA&&this.setWorldAnchorA(n.worldAnchorA),n.worldAnchorB&&this.setWorldAnchorB(n.worldAnchorB)}var o=e("../math/Vec3");f.exports=n,n.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},n.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},n.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},n.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var d=new o,i=new o,t=new o,l=new o,u=new o,p=new o,s=new o,c=new o,y=new o,a=new o,r=new o;n.prototype.applyForce=function(){var e=this.stiffness,f=this.damping,n=this.restLength,o=this.bodyA,w=this.bodyB,b=d,N=i,g=t,m=l,x=r,j=u,v=p,A=s,C=c,O=y,h=a;this.getWorldAnchorA(j),this.getWorldAnchorB(v),j.vsub(o.position,A),v.vsub(w.position,C),v.vsub(j,b);var k=b.norm();b.copy(N),N.normalize(),w.velocity.vsub(o.velocity,g),w.angularVelocity.cross(C,x),g.vadd(x,g),o.angularVelocity.cross(A,x),g.vsub(x,g),N.mult(-e*(k-n)-f*g.dot(N),m),o.force.vsub(m,o.force),w.force.vadd(m,w.force),A.cross(m,O),C.cross(m,h),o.tau.vsub(O,o.tau),w.tau.vadd(h,w.tau)}},{"../math/Vec3":25}],32:[function(e,f){function n(e){o.call(this),this.type=o.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3"),i=e("./ConvexPolyhedron");n.prototype=new o,n.prototype.constructor=n,n.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,f=this.halfExtents.y,n=this.halfExtents.z,o=d,t=new i([new o(-e,-f,-n),new o(e,-f,-n),new o(e,f,-n),new o(-e,f,-n),new o(-e,-f,n),new o(e,-f,n),new o(e,f,n),new o(-e,f,n)],[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],[new o(0,0,-1),new o(0,0,1),new o(0,-1,0),new o(0,1,0),new o(-1,0,0),new o(1,0,0)]);this.convexPolyhedronRepresentation=t},n.prototype.calculateLocalInertia=function(e,f){return f=f||new d,n.calculateInertia(this.halfExtents,e,f),f},n.calculateInertia=function(e,f,n){var o=e;n.x=1/12*f*(2*o.y*2*o.y+2*o.z*2*o.z),n.y=1/12*f*(2*o.x*2*o.x+2*o.z*2*o.z),n.z=1/12*f*(2*o.y*2*o.y+2*o.x*2*o.x)},n.prototype.getSideNormals=function(e,f){var n=e,o=this.halfExtents;if(n[0].set(o.x,0,0),n[1].set(0,o.y,0),n[2].set(0,0,o.z),n[3].set(-o.x,0,0),n[4].set(0,-o.y,0),n[5].set(0,0,-o.z),void 0!==f)for(var d=0;d!==n.length;d++)f.vmult(n[d],n[d]);return n},n.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};{var t=new d;new d}n.prototype.forEachWorldCorner=function(e,f,n){for(var o=this.halfExtents,d=[[o.x,o.y,o.z],[-o.x,o.y,o.z],[-o.x,-o.y,o.z],[-o.x,-o.y,-o.z],[o.x,-o.y,-o.z],[o.x,o.y,-o.z],[-o.x,o.y,-o.z],[o.x,-o.y,o.z]],i=0;i<d.length;i++)t.set(d[i][0],d[i][1],d[i][2]),f.vmult(t,t),e.vadd(t,t),n(t.x,t.y,t.z)},n.prototype.calculateWorldAABB=function(e,f,n,o){n.set(1/0,1/0,1/0),o.set(-1/0,-1/0,-1/0),this.forEachWorldCorner(e,f,function(e,f,d){e>o.x&&(o.x=e),f>o.y&&(o.y=f),d>o.z&&(o.z=d),e<n.x&&(n.x=e),f<n.y&&(n.y=f),d<n.z&&(n.z=d)})}},{"../math/Vec3":25,"./ConvexPolyhedron":34,"./Shape":38}],33:[function(e,f){function n(){o.call(this),this.type=o.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3"),i=e("../shapes/Box"),t=(e("../math/Mat3"),e("../math/Quaternion"));n.prototype=new o,n.prototype.constructor=n,n.prototype.addChild=function(e,f,n){f=f||new d,n=n||new t,this.childShapes.push(e),this.childOffsets.push(f),this.childOrientations.push(n),this.updateBoundingSphereRadius()},n.prototype.clearAllChildren=function(){this.childOffsets=[],this.childOrientations=[],this.childShapes=[]},n.prototype.volume=function(){for(var e=0,f=this.childShapes.length,n=0;n!==f;n++)e+=this.childShapes[n].volume();return e};var l=new d,u=new d,p=new d,s=new t;n.prototype.calculateLocalInertia=function(e,f){f=f||new d;var n=l,o=u,t=p,c=s;return this.calculateWorldAABB(t,c,n,o),i.calculateInertia(new d((o.x-n.x)/2,(o.y-n.y)/2,(o.z-n.z)/2),e,f),f},n.prototype.updateBoundingSphereRadius=function(){for(var e=0,f=0;f<this.childShapes.length;f++){var n=this.childShapes[f];n.updateBoundingSphereRadius();var o=this.childOffsets[f].norm()+n.boundingSphereRadius;o>e&&(e=o)}this.boundingSphereRadius=e};var c=new d,y=new d,a=new d,r=new t;n.prototype.calculateWorldAABB=function(e,f,n,o){var d=this.childShapes.length;n.set(1/0,1/0,1/0),o.set(-1/0,-1/0,-1/0);for(var i=0;i!==d;i++)this.childOffsets[i].copy(a),f.vmult(a,a),e.vadd(a,a),f.mult(this.childOrientations[i],r),this.childShapes[i].calculateWorldAABB(a,r,y,c),y.x<n.x&&(n.x=y.x),y.y<n.y&&(n.y=y.y),y.z<n.z&&(n.z=y.z),c.x>o.x&&(o.x=c.x),c.y>o.y&&(o.y=c.y),c.z>o.z&&(o.z=c.z)}},{"../math/Mat3":23,"../math/Quaternion":24,"../math/Vec3":25,"../shapes/Box":32,"./Shape":38}],34:[function(e,f){function n(e,f){o.call(this),this.type=o.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=f||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.computeEdges(),this.updateBoundingSphereRadius()}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3"),i=e("../math/Quaternion");n.prototype=new o,n.prototype.constructor=n,n.prototype.computeEdges=function(){var e=this.faces,f=this.vertices,n=f.length,o=this.uniqueEdges;o.length=0;for(var i=0;n>i;i++){var t=f[i];if(!(t instanceof d))throw"Argument 1 must be instance of Vec3";this.uniqueEdges.push(t)}for(var l=0;l<e.length;l++)for(var u=e[l],p=u.length,s=0;p>s;s++){var c=(s+1)%p,y=new d;f[u[s]].vsub(f[u[c]],y),y.normalize();for(var a=!1,t=0;t<o.length;t++)if(o[t].almostEquals(y)||o[t].almostEquals(y)){a=!0;break}a||o.push(y),y&&(y.face1=l)}},n.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var f=0;f<this.faces[e].length;f++)if(!this.vertices[this.faces[e][f]])throw new Error("Vertex "+this.faces[e][f]+" not found!");var n=this.faceNormals[e]||new d;this.getFaceNormal(e,n),n.negate(n),this.faceNormals[e]=n;var o=this.vertices[this.faces[e][0]];if(n.dot(o)<0){throw new Error(".faceNormals["+e+"] = Vec3("+n.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");var f}}};var t=new d,l=new d;n.computeNormal=function(e,f,n,o){f.vsub(e,l),n.vsub(f,t),t.cross(l,o),o.isZero()||o.normalize()},n.prototype.getFaceNormal=function(e,f){var o=this.faces[e],d=this.vertices[o[0]],i=this.vertices[o[1]],t=this.vertices[o[2]];return n.computeNormal(d,i,t,f)};var u=new d;n.prototype.clipAgainstHull=function(e,f,n,o,t,l,p,s,c){var y=u;if(!(e instanceof d))throw new Error("posA must be Vec3");if(!(f instanceof i))throw new Error("quatA must be Quaternion");for(var a=-1,r=-1/0,w=0;w<n.faces.length;w++){n.faceNormals[w].copy(y),t.vmult(y,y);var b=y.dot(l);b>r&&(r=b,a=w)}for(var N=[],g=n.faces[a],m=g.length,x=0;m>x;x++){var j=n.vertices[g[x]],v=new d;j.copy(v),t.vmult(v,v),o.vadd(v,v),N.push(v)}a>=0&&this.clipFaceAgainstHull(l,e,f,N,p,s,c)};var p=new d,s=new d,c=new d,y=new d,a=new d,r=new d;n.prototype.findSeparatingAxis=function(e,f,n,o,d,i){for(var t=p,l=s,u=c,w=y,b=a,N=r,g=1/0,m=this,x=0,j=m.faces.length,v=0;j>v;v++){m.faceNormals[v].copy(t),n.vmult(t,t);var A=m.testSepAxis(t,e,f,n,o,d);if(A===!1)return!1;g>A&&(g=A,t.copy(i))}for(var C=e.faces.length,v=0;C>v;v++){e.faceNormals[v].copy(l),d.vmult(l,l),x++;var A=m.testSepAxis(l,e,f,n,o,d);if(A===!1)return!1;g>A&&(g=A,l.copy(i))}for(var O=0,h=0;h<m.uniqueEdges.length;h++){m.uniqueEdges[h].copy(w),n.vmult(w,w);for(var k=0;k<e.uniqueEdges.length;k++)if(e.uniqueEdges[k].copy(b),d.vmult(b,b),w.cross(b,N),O++,!N.almostZero()){N.normalize();var q=m.testSepAxis(N,e,f,n,o,d);if(q===!1)return!1;g>q&&(g=q,N.copy(i))}}return o.vsub(f,u),u.dot(i)>0&&i.negate(i),!0},n.prototype.testSepAxis=function(e,f,o,d,i,t){var l=[],u=[],p=this;n.project(p,e,o,d,l),n.project(f,e,i,t,u);var s=l[0],c=l[1],y=u[0],a=u[1];if(a>s||c>y)return!1;var r=s-a,w=y-c,b=w>r?r:w;return b};var w=new d,b=new d;n.prototype.calculateLocalInertia=function(e,f){this.computeLocalAABB(w,b);var n=b.x-w.x,o=b.y-w.y,d=b.z-w.z;f.x=1/12*e*(2*o*2*o+2*d*2*d),f.y=1/12*e*(2*n*2*n+2*d*2*d),f.z=1/12*e*(2*o*2*o+2*n*2*n)},n.prototype.getPlaneConstantOfFace=function(e){var f=this.faces[e],n=this.faceNormals[e],o=this.vertices[f[0]],d=-n.dot(o);return d};var N=new d,g=new d,m=new d,x=new d,j=new d,v=new d,A=new d,C=new d;n.prototype.clipFaceAgainstHull=function(e,f,n,o,i,t,l){if(!(e instanceof d))throw new Error("sep normal must be vector");if(!(o instanceof Array))throw new Error("world verts must be array");var u=N,p=g,s=m,c=x,y=j,a=v,r=A,w=C;i=Number(i),t=Number(t);for(var b=this,O=[],h=o,k=O,q=-1,z=1/0,B=0;B<b.faces.length;B++){b.faceNormals[B].copy(u),n.vmult(u,u);var D=u.dot(e);z>D&&(z=D,q=B)}if(0>q)return void console.log("--- did not find any closest face... ---");var E=b.faces[q];E.connectedFaces=[];for(var F=0;F<b.faces.length;F++)for(var G=0;G<b.faces[F].length;G++)-1!==E.indexOf(b.faces[F][G])&&F!==q&&-1===E.connectedFaces.indexOf(F)&&E.connectedFaces.push(F);for(var H=(h.length,E.length),I=0;H>I;I++){var J=b.vertices[E[I]],K=b.vertices[E[(I+1)%H]];J.vsub(K,p),p.copy(s),n.vmult(s,s),f.vadd(s,s),this.faceNormals[q].copy(c),n.vmult(c,c),f.vadd(c,c),s.cross(c,y),y.negate(y),J.copy(a),n.vmult(a,a),f.vadd(a,a);var L,M=(-a.dot(y),E.connectedFaces[I]);this.faceNormals[M].copy(r);var P=this.getPlaneConstantOfFace(M);r.copy(w),n.vmult(w,w);var L=P-w.dot(f);for(this.clipFaceAgainstPlane(h,k,w,L);h.length;)h.shift();for(;k.length;)h.push(k.shift())}this.faceNormals[q].copy(r);var P=this.getPlaneConstantOfFace(q);r.copy(w),n.vmult(w,w);for(var L=P-w.dot(f),F=0;F<h.length;F++){var Q=w.dot(h[F])+L;if(i>=Q&&(console.log("clamped: depth="+Q+" to minDist="+(i+"")),Q=i),t>=Q){var R=h[F];if(0>=Q){var S={point:R,normal:w,depth:Q};l.push(S)}}}},n.prototype.clipFaceAgainstPlane=function(e,f,n,o){if(!(n instanceof d))throw new Error("planeNormal must be Vec3, "+n+" given");if(!(e instanceof Array))throw new Error("invertices must be Array, "+e+" given");if(!(f instanceof Array))throw new Error("outvertices must be Array, "+f+" given");var i,t,l=e.length;if(2>l)return f;var u=e[e.length-1],p=e[0];i=n.dot(u)+o;for(var s=0;l>s;s++){if(p=e[s],t=n.dot(p)+o,0>i)if(0>t){var c=new d;p.copy(c),f.push(c)}else{var c=new d;u.lerp(p,i/(i-t),c),f.push(c)}else if(0>t){var c=new d;u.lerp(p,i/(i-t),c),f.push(c),f.push(p)}u=p,i=t}return f},n.prototype.computeWorldVertices=function(e,f){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new d);for(var o=this.vertices,i=this.worldVertices,t=0;t!==n;t++)f.vmult(o[t],i[t]),e.vadd(i[t],i[t]);this.worldVerticesNeedsUpdate=!1};new d;n.prototype.computeLocalAABB=function(e,f){var n=this.vertices.length,o=this.vertices;e.set(1/0,1/0,1/0),f.set(-1/0,-1/0,-1/0);for(var d=0;n>d;d++){var i=o[d];i.x<e.x?e.x=i.x:i.x>f.x&&(f.x=i.x),i.y<e.y?e.y=i.y:i.y>f.y&&(f.y=i.y),i.z<e.z?e.z=i.z:i.z>f.z&&(f.z=i.z)}},n.prototype.computeWorldFaceNormals=function(e){for(var f=this.faceNormals.length;this.worldFaceNormals.length<f;)this.worldFaceNormals.push(new d);for(var n=this.faceNormals,o=this.worldFaceNormals,i=0;i!==f;i++)e.vmult(n[i],o[i]);this.worldFaceNormalsNeedsUpdate=!1},n.prototype.updateBoundingSphereRadius=function(){for(var e=0,f=this.vertices,n=0,o=f.length;n!==o;n++){var d=f[n].norm2();d>e&&(e=d)}this.boundingSphereRadius=Math.sqrt(e)};var O=new d;n.prototype.calculateWorldAABB=function(e,f,n,o){for(var d,i,t,l,u,p,s=this.vertices.length,c=this.vertices,y=0;s>y;y++){c[y].copy(O),f.vmult(O,O),e.vadd(O,O);var a=O;a.x<d||void 0===d?d=a.x:(a.x>l||void 0===l)&&(l=a.x),a.y<i||void 0===i?i=a.y:(a.y>u||void 0===u)&&(u=a.y),a.z<t||void 0===t?t=a.z:(a.z>p||void 0===p)&&(p=a.z)}n.set(d,i,t),o.set(l,u,p)},n.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},n.prototype.getAveragePointLocal=function(e){e=e||new d;for(var f=this.vertices.length,n=this.vertices,o=0;f>o;o++)e.vadd(n[o],e);return e.mult(1/f,e),e},n.prototype.transformAllPoints=function(e,f){var n=this.vertices.length,o=this.vertices;if(f){for(var d=0;n>d;d++){var i=o[d];f.vmult(i,i)}for(var d=0;d<this.faceNormals.length;d++){var i=this.faceNormals[d];f.vmult(i,i)}}if(e)for(var d=0;n>d;d++){var i=o[d];i.vadd(e,i)}};var h=new d,k=new d,q=new d;n.prototype.pointIsInside=function(e){var f=this.vertices.length,n=this.vertices,o=this.faces,d=this.faceNormals,i=null,t=this.faces.length,l=h;this.getAveragePointLocal(l);for(var u=0;t>u;u++){var f=(this.faces[u].length,d[u]),p=n[o[u][0]],s=k;e.vsub(p,s);var c=f.dot(s),y=q;l.vsub(p,y);var a=f.dot(y);if(0>c&&a>0||c>0&&0>a)return!1}return i?1:-1};var z=new d;n.project=function(e,f,n,o,d){for(var i=e.vertices.length,t=z,l=null,u=null,p=e.vertices,s=0;i>s;s++){p[s].copy(t),o.vmult(t,t),t.vadd(n,t);var c=t.dot(f);(null===l||c>l)&&(l=c),(null===u||u>c)&&(u=c)}if(u>l){var y=u;u=l,l=y}d[0]=l,d[1]=u}},{"../math/Quaternion":24,"../math/Vec3":25,"./Shape":38}],35:[function(e,f){function n(e,f,n,t){var l=t,u=[],p=[],s=[],c=[],y=[],a=Math.cos,r=Math.sin;u.push(new d(f*a(0),f*r(0),.5*-n)),c.push(0),u.push(new d(e*a(0),e*r(0),.5*n)),y.push(1);for(var w=0;l>w;w++){var b=2*Math.PI/l*(w+1),N=2*Math.PI/l*(w+.5);l-1>w?(u.push(new d(f*a(b),f*r(b),.5*-n)),c.push(2*w+2),u.push(new d(e*a(b),e*r(b),.5*n)),y.push(2*w+3),p.push(new d(a(N),r(N),0)),s.push([2*w+2,2*w+3,2*w+1,2*w])):(s.push([0,1,2*w+1,2*w]),p.push(new d(a(N),r(N),0)))}s.push(y),p.push(new d(0,0,1));for(var g=[],w=0;w<c.length;w++)g.push(c[c.length-w-1]);s.push(g),p.push(new d(0,0,-1)),this.type=o.types.CONVEXPOLYHEDRON,i.call(this,u,s,p)}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3"),i=(e("../math/Quaternion"),e("./ConvexPolyhedron"));n.prototype=new i},{"../math/Quaternion":24,"../math/Vec3":25,"./ConvexPolyhedron":34,"./Shape":38}],36:[function(e,f){function n(e,f){if(f=t.defaults(f,{maxValue:null,minValue:null,elementSize:1}),null===f.minValue){f.minValue=e[0][0];for(var n=0;n!==e.length;n++)for(var l=0;l!==e[n].length;l++){var u=e[n][l];u<f.minValue&&(f.minValue=u)}}if(null===f.maxValue){f.maxValue=e[0][0];for(var n=0;n!==e.length;n++)for(var l=0;l!==e[n].length;l++){var u=e[n][l];u>f.maxValue&&(f.maxValue=u)}}this.data=e,this.maxValue=f.maxValue,this.minValue=f.minValue,this.elementSize=f.elementSize,this.cacheEnabled=!0,o.call(this),this.pillarConvex=new d,this.pillarOffset=new i,this.type=o.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var o=e("./Shape"),d=e("./ConvexPolyhedron"),i=e("../math/Vec3"),t=e("../utils/Utils");f.exports=n,n.prototype=new o,n.prototype.update=function(){this._cachedPillars={}},n.prototype.getRectMinMax=function(e,f,n,o,d){d=d||[];for(var i=this.data,t=this.minValue,l=e;n>l;l++)for(var u=f;o>u;u++){var p=i[l][u];p>t&&(t=p)}d[0]=this.minValue,d[1]=t},n.prototype.getCachedConvexTrianglePillar=function(e,f,n){return this._cachedPillars[e+"_"+f+"_"+(n?1:0)]},n.prototype.setCachedConvexTrianglePillar=function(e,f,n,o,d){this._cachedPillars[e+"_"+f+"_"+(n?1:0)]={convex:o,offset:d}},n.prototype.getConvexTrianglePillar=function(e,f,n){var o=this.pillarConvex,t=this.pillarOffset;if(this.cacheEnabled){var l=this.getCachedConvexTrianglePillar(e,f,n);if(l)return this.pillarConvex=l.convex,void(this.pillarOffset=l.offset);o=new d,t=new i,this.pillarConvex=o,this.pillarOffset=t}var l=this.data,u=this.elementSize,p=o.faces;o.vertices.length=6;for(var s=0;6>s;s++)o.vertices[s]||(o.vertices[s]=new i);p.length=5;for(var s=0;5>s;s++)p[s]||(p[s]=[]);var c=o.vertices,y=(Math.min(l[e][f],l[e+1][f],l[e][f+1],l[e+1][f+1])-this.minValue)/2+this.minValue;n?(t.set((e+.75)*u,(f+.75)*u,y),c[0].set(.25*u,.25*u,l[e+1][f+1]-y),c[1].set(-.75*u,.25*u,l[e][f+1]-y),c[2].set(.25*u,-.75*u,l[e+1][f]-y),c[3].set(.25*u,.25*u,-y),c[4].set(-.75*u,.25*u,-y),c[5].set(.25*u,-.75*u,-y),p[0][0]=0,p[0][1]=1,p[0][2]=2,p[1][0]=5,p[1][1]=4,p[1][2]=3,p[2][0]=2,p[2][1]=5,p[2][2]=3,p[2][3]=0,p[3][0]=3,p[3][1]=4,p[3][2]=1,p[3][3]=0,p[4][0]=1,p[4][1]=4,p[4][2]=5,p[4][3]=2):(t.set((e+.25)*u,(f+.25)*u,y),c[0].set(-.25*u,-.25*u,l[e][f]-y),c[1].set(.75*u,-.25*u,l[e+1][f]-y),c[2].set(-.25*u,.75*u,l[e][f+1]-y),c[3].set(-.25*u,-.25*u,-y),c[4].set(.75*u,-.25*u,-y),c[5].set(-.25*u,.75*u,-y),p[0][0]=0,p[0][1]=1,p[0][2]=2,p[1][0]=5,p[1][1]=4,p[1][2]=3,p[2][0]=0,p[2][1]=2,p[2][2]=5,p[2][3]=3,p[3][0]=1,p[3][1]=0,p[3][2]=3,p[3][3]=4,p[4][0]=4,p[4][1]=5,p[4][2]=2,p[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,f,n,o,t)
},n.prototype.calculateLocalInertia=function(e,f){return f=f||new i,f.set(0,0,0),f},n.prototype.volume=function(){return Number.MAX_VALUE},n.prototype.calculateWorldAABB=function(e,f,n,o){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},n.prototype.updateBoundingSphereRadius=function(){var e=this.data,f=this.elementSize;this.boundingSphereRadius=new i(e.length*f,e[0].length*f,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":25,"../utils/Utils":46,"./ConvexPolyhedron":34,"./Shape":38}],37:[function(e,f){function n(){o.call(this),this.type=o.types.PLANE,this.worldNormal=new d,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3");n.prototype=new o,n.prototype.constructor=n,n.prototype.computeWorldNormal=function(e){var f=this.worldNormal;f.set(0,0,1),e.vmult(f,f),this.worldNormalNeedsUpdate=!1},n.prototype.calculateLocalInertia=function(e,f){return f=f||new d},n.prototype.volume=function(){return Number.MAX_VALUE};var i=new d;n.prototype.calculateWorldAABB=function(e,f,n,o){i.set(0,0,1),f.vmult(i,i);var o=Number.MAX_VALUE;n.set(-o,-o,-o),o.set(o,o,o),1===i.x&&(o.x=e.x),1===i.y&&(o.y=e.y),1===i.z&&(o.z=e.z),-1===i.x&&(n.x=e.x),-1===i.y&&(n.y=e.y),-1===i.z&&(n.z=e.z)}},{"../math/Vec3":25,"./Shape":38}],38:[function(e,f){function n(){this.type=0,this.boundingSphereRadius=0}f.exports=n;{var n=e("./Shape");e("../math/Vec3"),e("../math/Quaternion"),e("../objects/Particle"),e("../material/Material")}n.prototype.constructor=n,n.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},n.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},n.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},n.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32}},{"../material/Material":21,"../math/Quaternion":24,"../math/Vec3":25,"../objects/Particle":27,"./Shape":38}],39:[function(e,f){function n(e){o.call(this),this.radius=void 0!==e?Number(e):1,this.type=o.types.SPHERE,this.updateBoundingSphereRadius()}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3");n.prototype=new o,n.prototype.constructor=n,n.prototype.calculateLocalInertia=function(e,f){f=f||new d;var n=2*e*this.radius*this.radius/5;return f.x=n,f.y=n,f.z=n,f},n.prototype.volume=function(){return 4*Math.PI*this.radius/3},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},n.prototype.calculateWorldAABB=function(e,f,n,o){for(var d=this.radius,i=["x","y","z"],t=0;t<i.length;t++){var l=i[t];n[l]=e[l]-d,o[l]=e[l]+d}}},{"../math/Vec3":25,"./Shape":38}],40:[function(e,f){function n(){o.call(this),this.iterations=10,this.tolerance=0}f.exports=n;var o=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver"));n.prototype=new o;var d=[],i=[],t=[];n.prototype.solve=function(e,f){var n,o,l,u,p,s,c=0,y=this.iterations,a=this.tolerance*this.tolerance,r=this.equations,w=r.length,b=f.bodies,N=b.length,g=e;if(0!==w)for(var m=0;m!==N;m++)b[m].updateSolveMassProperties();var x=i,j=t,v=d;x.length=w,j.length=w,v.length=w;for(var m=0;m!==w;m++){var A=r[m];v[m]=0,j[m]=A.computeB(g),x[m]=1/A.computeC()}if(0!==w){for(var m=0;m!==N;m++){var C=b[m],O=C.vlambda,h=C.wlambda;O.set(0,0,0),h&&h.set(0,0,0)}for(c=0;c!==y;c++){u=0;for(var k=0;k!==w;k++){var A=r[k];n=j[k],o=x[k],s=v[k],p=A.computeGWlambda(),l=o*(n-p-A.eps*s),s+l<A.minForce?l=A.minForce-s:s+l>A.maxForce&&(l=A.maxForce-s),v[k]+=l,u+=l>0?l:-l,A.addToWlambda(l)}if(a>u*u)break}for(var m=0;m!==N;m++){var C=b[m],q=C.velocity,z=C.angularVelocity;q.vadd(C.vlambda,q),z&&z.vadd(C.wlambda,z)}}return c}},{"../math/Quaternion":24,"../math/Vec3":25,"./Solver":41}],41:[function(e,f){function n(){this.equations=[]}f.exports=n,n.prototype.solve=function(){return 0},n.prototype.addEquation=function(e){this.equations.push(e)},n.prototype.removeEquation=function(e){var f=this.equations,n=f.indexOf(e);-1!==n&&f.splice(n,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],42:[function(e,f){function n(e){o.call(this),this.subsolver=e}f.exports=n;var o=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver")),d=e("../objects/Body");n.prototype=new o;var i=[],t=[],l=[],u={bodies:null};n.prototype.solve=function(e,f){function n(e){for(var f=e.length,n=0;n!==f;n++){var o=e[n];if(!(o.visited||o.body.type&C))return o}return!1}function o(e,f){var o=[];for(o.push(e),e.visited=!0,f(e);o.length;)for(var d,i=o.pop();d=n(i.children);)d.visited=!0,f(d),o.push(d)}function p(e){k.push(e.body);for(var f=e.eqs.length,n=0;n!==f;n++){var o=e.eqs[n];-1===h.indexOf(o)&&h.push(o)}}var s=i,c=f.bodies,y=this.equations,a=y.length,r=c.length,w=this.subsolver;for(s.length>r&&(s.length=r);s.length<r;)s.push({body:null,children:[],eqs:[],visited:!1});for(var b=0;b!==r;b++){var N=s[b];N.body=c[b],N.children.length=0,N.eqs.length=0,N.visited=!1}for(var g=0;g!==a;g++){var m=y[g],b=c.indexOf(m.bi),x=c.indexOf(m.bj),j=s[b],v=s[x];j.children.push(v),j.eqs.push(m),v.children.push(j),v.eqs.push(m)}for(var A,C=d.STATIC,O=0,h=t,k=l,q=u;A=n(s);){h.length=0,k.length=0,o(A,p);for(var z=h.length,b=0;b!==z;b++)w.addEquation(h[b]);q.bodies=k;{w.solve(e,q)}w.removeAllEquations(),O++}return O}},{"../math/Quaternion":24,"../math/Vec3":25,"../objects/Body":26,"./Solver":41}],43:[function(e,f){var n=function(){};f.exports=n,n.prototype={constructor:n,addEventListener:function(e,f){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(f)&&n[e].push(f),this},hasEventListener:function(e,f){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(f)?!0:!1},removeEventListener:function(e,f){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[e])return this;var o=n[e].indexOf(f);return-1!==o&&n[e].splice(o,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var f=this._listeners,n=f[e.type];if(void 0!==n){e.target=this;for(var o=0,d=n.length;d>o;o++)n[o].call(this,e)}return this}}},{}],44:[function(e,f){function n(){this.objects=[],this.type=Object}f.exports=n,n.prototype.release=function(){for(var e=arguments.length,f=0;f!==e;f++)this.objects.push(arguments[f])},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],45:[function(e,f){function n(){this.data={keys:[]}}f.exports=n,n.prototype.get=function(e,f){if(e>f){var n=f;f=e,e=n}return this.data[e+"-"+f]},n.prototype.set=function(e,f,n){if(e>f){var o=f;f=e,e=o}var d=e+"-"+f;this.get(e,f)||this.data.keys.push(d),this.data[d]=n},n.prototype.reset=function(){for(var e=this.data,f=e.keys;f.length>0;){var n=f.pop();delete e[n]}}},{}],46:[function(e,f){function n(){}f.exports=n,n.defaults=function(e,f){e=e||{};for(var n in f)n in e||(e[n]=f[n]);return e}},{}],47:[function(e,f){function n(){d.call(this),this.type=o}f.exports=n;var o=e("../math/Vec3"),d=e("./Pool");n.prototype=new d,n.prototype.constructObject=function(){return new o}},{"../math/Vec3":25,"./Pool":44}],48:[function(e,f){function n(){this.contactReduction=!1,this.contactPointPool=[],this.v3pool=new u}function o(e){s>c||(s++,console.warn(e))}function d(e,f,n){for(var o=null,d=e.length,i=0;i!==d;i++){var t=e[i],l=r;e[(i+1)%d].vsub(t,l);var u=w;l.cross(f,u);var p=b;n.vsub(t,p);var s=u.dot(p);if(!(null===o||s>0&&o===!0||0>=s&&o===!1))return!1;null===o&&(o=s>0)}return!0}f.exports=n;var i=e("../shapes/Shape"),t=e("../math/Vec3"),l=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),u=(e("../solver/Solver"),e("../utils/Vec3Pool")),p=e("../equations/ContactEquation");n.prototype.swapResult=function(e){var f;f=e.ri,e.ri=e.rj,e.rj=f,e.ni.negate(e.ni),f=e.bi,e.bi=e.bj,e.bj=f},n.prototype.reduceContacts=function(){},n.prototype.makeResult=function(e,f){if(this.contactPointPool.length){var n=this.contactPointPool.pop();return n.bi=e,n.bj=f,n}return new p(e,f)},n.prototype.getContacts=function(e,f,n,o,d){this.contactPointPool=d;for(var i=0,t=e.length;i!==t;i++){var l=e[i],u=f[i];this.narrowphase(o,l.shape,u.shape,l.position,u.position,l.quaternion,u.quaternion,l,u)}};var s=0,c=10;n.prototype.narrowphase=function(e,f,n,d,t,l,u,p,s){var c=!1,y=i.types,a=y.SPHERE,r=y.PLANE,w=y.BOX,b=y.COMPOUND,N=y.CONVEXPOLYHEDRON,g=y.HEIGHTFIELD;if(f&&n){if(f.type>n.type){var m;m=n,n=f,f=m,m=t,t=d,d=m,m=u,u=l,l=m,m=s,s=p,p=m,c=!0}}else if(f&&!n){var m;m=n,n=f,f=m,m=t,t=d,d=m,m=u,u=l,l=m,m=s,s=p,p=m,c=!0}if(f&&n){if(f.type===a)switch(n.type){case a:this.sphereSphere(e,f,n,d,t,l,u,p,s);break;case r:this.spherePlane(e,f,n,d,t,l,u,p,s);break;case w:this.sphereBox(e,f,n,d,t,l,u,p,s);break;case b:this.recurseCompound(e,f,n,d,t,l,u,p,s);break;case N:this.sphereConvex(e,f,n,d,t,l,u,p,s);break;case g:this.sphereHeightfield(e,f,n,d,t,l,u,p,s);break;default:o("Collision between Shape.types.SPHERE and "+n.type+" not implemented yet.")}else if(f.type===y.PLANE)switch(n.type){case y.PLANE:break;case y.BOX:this.planeBox(e,f,n,d,t,l,u,p,s);break;case y.COMPOUND:this.recurseCompound(e,f,n,d,t,l,u,p,s);break;case y.CONVEXPOLYHEDRON:this.planeConvex(e,f,n,d,t,l,u,p,s);break;default:o("Collision between Shape.types.PLANE and "+n.type+" not implemented yet.")}else if(f.type===y.BOX)switch(n.type){case y.BOX:this.narrowphase(e,f.convexPolyhedronRepresentation,n.convexPolyhedronRepresentation,d,t,l,u,p,s);break;case y.COMPOUND:this.recurseCompound(e,f,n,d,t,l,u,p,s);break;case y.CONVEXPOLYHEDRON:this.narrowphase(e,f.convexPolyhedronRepresentation,n,d,t,l,u,p,s);break;default:o("Collision between Shape.types.BOX and "+n.type+" not implemented yet.")}else if(f.type===y.COMPOUND)switch(n.type){case y.COMPOUND:this.recurseCompound(e,f,n,d,t,l,u,p,s);break;case y.CONVEXPOLYHEDRON:var x=[];this.recurseCompound(x,n,f,t,d,u,l,s,p);for(var j=0;j!==x.length;j++)this.swapResult(x[j]),e.push(x[j]);break;default:o("Collision between Shape.types.COMPOUND and "+n.type+" not implemented yet.")}else if(f.type===y.CONVEXPOLYHEDRON)switch(n.type){case y.CONVEXPOLYHEDRON:this.convexConvex(e,f,n,d,t,l,u,p,s);break;default:o("Collision between Shape.types.CONVEXPOLYHEDRON and "+n.type+" not implemented yet.")}else if(f.type===y.HEIGHTFIELD)switch(n.type){case y.SPHERE:this.sphereHeightfield(e,f,n,d,t,l,u,p,s);break;default:o("Collision between Shape.types.HEIGHTFIELD and "+n.type+" not implemented yet.")}}else switch(n.type){case y.PLANE:this.particlePlane(e,f,n,d,t,l,u,p,s);break;case y.SPHERE:this.particleSphere(e,f,n,d,t,l,u,p,s);break;case y.BOX:this.particleConvex(e,f,n.convexPolyhedronRepresentation,d,t,l,u,p,s);break;case y.CONVEXPOLYHEDRON:this.particleConvex(e,f,n,d,t,l,u,p,s);break;case y.COMPOUND:this.recurseCompound(e,f,n,d,t,l,u,p,s);break;default:console.warn("Collision between Particle and "+n.type+" not implemented yet.")}for(var v=0,A=e.length;c&&v!==A;v++)this.swapResult(e[v])},n.prototype.sphereSphere=function(e,f,n,o,d,i,t,l,u){var p=this.makeResult(l,u);u.position.vsub(o,p.ni),p.ni.normalize(),p.ni.copy(p.ri),p.ni.copy(p.rj),p.ri.mult(f.radius,p.ri),p.rj.mult(-n.radius,p.rj),e.push(p)};var y=new t,a=new t;n.prototype.spherePlane=function(e,f,n,o,d,i,t,l,u){var p=this.makeResult(l,u);p.ni.set(0,0,1),t.vmult(p.ni,p.ni),p.ni.negate(p.ni),p.ni.normalize(),p.ni.mult(f.radius,p.ri),o.vsub(d,y),p.ni.mult(p.ni.dot(y),a),y.vsub(a,p.rj),a.norm2()<=f.radius*f.radius&&e.push(p)};var r=new t,w=new t,b=new t,N=new t,g=new t,m=new t,x=new t,j=[new t,new t,new t,new t,new t,new t],v=new t,A=new t,C=new t,O=new t;n.prototype.sphereBox=function(e,f,n,o,d,i,t,l,u){var p=this.v3pool,s=j;o.vsub(d,N),n.getSideNormals(s,t);for(var c=f.radius,y=!1,a=A,r=C,w=O,b=null,h=0,k=0,q=0,z=null,B=0,D=s.length;B!==D&&y===!1;B++){var E=g;s[B].copy(E);var F=E.norm();E.normalize();var G=N.dot(E);if(F+c>G&&G>0){var H=m,I=x;s[(B+1)%3].copy(H),s[(B+2)%3].copy(I);var J=H.norm(),K=I.norm();H.normalize(),I.normalize();var L=N.dot(H),M=N.dot(I);if(J>L&&L>-J&&K>M&&M>-K){var P=Math.abs(G-F-c);(null===z||z>P)&&(z=P,k=L,q=M,b=F,E.copy(a),H.copy(r),I.copy(w),h++)}}}if(h){y=!0;var Q=this.makeResult(l,u);a.mult(-c,Q.ri),a.copy(Q.ni),Q.ni.negate(Q.ni),a.mult(b,a),r.mult(k,r),a.vadd(r,a),w.mult(q,w),a.vadd(w,Q.rj),e.push(Q)}for(var R=p.get(),S=v,T=0;2!==T&&!y;T++)for(var U=0;2!==U&&!y;U++)for(var V=0;2!==V&&!y;V++)if(R.set(0,0,0),T?R.vadd(s[0],R):R.vsub(s[0],R),U?R.vadd(s[1],R):R.vsub(s[1],R),V?R.vadd(s[2],R):R.vsub(s[2],R),d.vadd(R,S),S.vsub(o,S),S.norm2()<c*c){y=!0;var Q=this.makeResult(l,u);S.copy(Q.ri),Q.ri.normalize(),Q.ri.copy(Q.ni),Q.ri.mult(c,Q.ri),R.copy(Q.rj),e.push(Q)}p.release(R),R=null;for(var W=p.get(),X=p.get(),Q=p.get(),Y=p.get(),P=p.get(),Z=s.length,T=0;T!==Z&&!y;T++)for(var U=0;U!==Z&&!y;U++)if(T%3!==U%3){s[U].cross(s[T],W),W.normalize(),s[T].vadd(s[U],X),o.copy(Q),Q.vsub(X,Q),Q.vsub(d,Q);var $=Q.dot(W);W.mult($,Y);for(var V=0;V===T%3||V===U%3;)V++;o.copy(P),P.vsub(Y,P),P.vsub(X,P),P.vsub(d,P);var _=Math.abs($),ef=P.norm();if(_<s[V].norm()&&c>ef){y=!0;var ff=this.makeResult(l,u);X.vadd(Y,ff.rj),ff.rj.copy(ff.rj),P.negate(ff.ni),ff.ni.normalize(),ff.rj.copy(ff.ri),ff.ri.vadd(d,ff.ri),ff.ri.vsub(o,ff.ri),ff.ri.normalize(),ff.ri.mult(c,ff.ri),e.push(ff)}}p.release(W,X,Q,Y,P)};var h=new t,k=new t,q=new t,z=new t,B=new t,D=new t,E=new t,F=new t,G=new t,H=new t;n.prototype.sphereConvex=function(e,f,n,o,i,t,l,u,p){var s=this.v3pool;o.vsub(i,h);for(var c=n.faceNormals,y=n.faces,a=n.vertices,r=f.radius,w=0;w!==a.length;w++){var b=a[w],N=B;l.vmult(b,N),i.vadd(N,N);var g=z;if(N.vsub(o,g),g.norm2()<r*r){x=!0;var m=this.makeResult(u,p);return g.copy(m.ri),m.ri.normalize(),m.ri.copy(m.ni),m.ri.mult(r,m.ri),N.vsub(i,m.rj),m.ri.vadd(o,m.ri),m.ri.vsub(u.position,m.ri),m.rj.vadd(i,m.rj),m.rj.vsub(p.position,m.rj),void e.push(m)}}for(var x=!1,w=0,j=y.length;w!==j&&x===!1;w++){var v=c[w],A=y[w],C=D;l.vmult(v,C);var O=E;l.vmult(a[A[0]],O),O.vadd(i,O);var I=F;C.mult(-r,I),o.vadd(I,I);var J=G;I.vsub(O,J);var K=J.dot(C),L=H;if(o.vsub(O,L),0>K&&L.dot(C)>0){for(var M=[],P=0,Q=A.length;P!==Q;P++){var R=s.get();l.vmult(a[A[P]],R),i.vadd(R,R),M.push(R)}if(d(M,C,o)){x=!0;var m=this.makeResult(u,p);C.mult(-r,m.ri),C.negate(m.ni);var S=s.get();C.mult(-K,S);var T=s.get();C.mult(-r,T),o.vsub(i,m.rj),m.rj.vadd(T,m.rj),m.rj.vadd(S,m.rj),m.rj.vadd(i,m.rj),m.rj.vsub(p.position,m.rj),m.ri.vadd(o,m.ri),m.ri.vsub(u.position,m.ri),s.release(S),s.release(T),e.push(m);for(var P=0,U=M.length;P!==U;P++)s.release(M[P]);return}for(var P=0;P!==A.length;P++){var V=s.get(),W=s.get();l.vmult(a[A[(P+1)%A.length]],V),l.vmult(a[A[(P+2)%A.length]],W),i.vadd(V,V),i.vadd(W,W);var X=k;W.vsub(V,X);var Y=q;X.unit(Y);var Z=s.get(),$=s.get();o.vsub(V,$);var _=$.dot(Y);Y.mult(_,Z),Z.vadd(V,Z);var ef=s.get();if(Z.vsub(o,ef),_>0&&_*_<X.norm2()&&ef.norm2()<r*r){var m=this.makeResult(u,p);Z.vsub(i,m.rj),Z.vsub(o,m.ni),m.ni.normalize(),m.ni.mult(r,m.ri),m.rj.vadd(i,m.rj),m.rj.vsub(p.position,m.rj),m.ri.vadd(o,m.ri),m.ri.vsub(u.position,m.ri),e.push(m);for(var P=0,U=M.length;P!==U;P++)s.release(M[P]);return s.release(V),s.release(W),s.release(Z),s.release(ef),void s.release($)}s.release(V),s.release(W),s.release(Z),s.release(ef),s.release($)}for(var P=0,U=M.length;P!==U;P++)s.release(M[P])}}};new t,new t;n.prototype.planeBox=function(e,f,n,o,d,i,t,l,u){this.planeConvex(e,f,n.convexPolyhedronRepresentation,o,d,i,t,l,u)};var I=[],J=[];n.prototype.recurseCompound=function(e,f,n,o,d,i,u,p,s){for(var c=I,y=J,a=0,r=0,w=n.childShapes.length;r!==w;r++){var b=[],N=y.pop()||new l,g=c.pop()||new t;u.mult(n.childOrientations[r],N),N.normalize(),u.vmult(n.childOffsets[r],g),d.vadd(g,g),this.narrowphase(b,f,n.childShapes[r],o,g,i,N,p,s),y.push(N);var m=g;f||(a+=b.length);for(var x=0;x!==b.length;x++)u.vmult(n.childOffsets[r],m),b[x].rj.vadd(m,b[x].rj),e.push(b[x]);c.push(g)}};var K=new t,L=new t,M=new t,P=new t;n.prototype.planeConvex=function(e,f,n,o,d,i,t,l,u){var p=K,s=L;s.set(0,0,1),i.vmult(s,s);for(var c=M,y=0;y!==n.vertices.length;y++){n.vertices[y].copy(p),t.vmult(p,p),d.vadd(p,p),p.vsub(o,c);var a=s.dot(c);if(0>=a){var r=this.makeResult(l,u),w=P;s.mult(s.dot(c),w),p.vsub(w,w),w.vsub(o,r.ri),s.copy(r.ni),p.vsub(d,r.rj),e.push(r)}}};var Q=new t,R=new t;n.prototype.convexConvex=function(e,f,n,o,d,i,t,l,u){var p=Q;if(f.findSeparatingAxis(n,o,i,d,t,p)){var s=[],c=R;f.clipAgainstHull(o,i,n,d,t,p,-100,100,s);for(var y=0;y!==s.length;y++){var a=this.makeResult(l,u);p.negate(a.ni),s[y].normal.negate(c),c.mult(s[y].depth,c),s[y].point.vadd(c,a.ri),s[y].point.copy(a.rj),a.rj.vsub(d,a.rj),a.ri.vsub(o,a.ri),e.push(a)}}};var S=new t,T=new t,U=new t;n.prototype.particlePlane=function(e,f,n,o,d,i,t,l,u){var p=S;p.set(0,0,1),u.quaternion.vmult(p,p);var s=T;o.vsub(u.position,s);var c=p.dot(s);if(0>=c){var y=this.makeResult(l,u);p.copy(y.ni),y.ni.negate(y.ni),y.ri.set(0,0,0);var a=U;p.mult(p.dot(o),a),o.vsub(a,a),a.copy(y.rj),e.push(y)}};var V=new t;n.prototype.particleSphere=function(e,f,n,o,d,i,t,l,u){var p=V;p.set(0,0,1),o.vsub(d,p);var s=p.norm2();if(s<=n.radius*n.radius){var c=this.makeResult(l,u);p.normalize(),p.copy(c.rj),c.rj.mult(n.radius,c.rj),p.copy(c.ni),c.ni.negate(c.ni),c.ri.set(0,0,0),e.push(c)}};var W=new l,X=new t,Y=(new t,new t),Z=new t,$=new t;n.prototype.particleConvex=function(e,f,n,o,d,i,t,l,u){var p=-1,s=Y,c=$,y=null,a=0,r=X;if(o.copy(r),r.vsub(d,r),t.conjugate(W),W.vmult(r,r),n.pointIsInside(r)){n.worldVerticesNeedsUpdate&&n.computeWorldVertices(d,t),n.worldFaceNormalsNeedsUpdate&&n.computeWorldFaceNormals(t);for(var w=0,b=n.faces.length;w!==b;w++){var N=[n.worldVertices[n.faces[w][0]]],g=n.worldFaceNormals[w];o.vsub(N[0],Z);var m=-g.dot(Z);(null===y||Math.abs(m)<Math.abs(y))&&(y=m,p=w,g.copy(s),a++)}if(-1!==p){var x=this.makeResult(l,u);s.mult(y,c),c.vadd(o,c),c.vsub(d,c),c.copy(x.rj),s.negate(x.ni),x.ri.set(0,0,0),e.push(x)}else console.warn("Point found inside convex, but did not find penetrating face!")}};var _=new t,ef=new t;n.prototype.sphereHeightfield=function(e,f,n,o,d,i,t,l,u){var p=n.data,s=f.radius,c=n.elementSize,y=ef,a=_;u.pointToLocalFrame(o,a);var r=Math.floor((a.x-s)/c)-1,w=Math.ceil((a.x+s)/c)+1,b=Math.floor((a.y-s)/c)-1,N=Math.ceil((a.y+s)/c)+1;if(!(0>w||0>N||r>p.length||N>p[0].length)){0>r&&(r=0),0>w&&(w=0),0>b&&(b=0),0>N&&(N=0),r>=p.length&&(r=p.length-1),w>=p.length&&(w=p.length-1),N>=p[0].length&&(N=p[0].length-1),b>=p[0].length&&(b=p[0].length-1);var g=[];n.getRectMinMax(r,b,w,N,g);var m=g[0],x=g[1];if(!(a.z-s>x||a.z+s<m))for(var j=r;w>j;j++)for(var v=b;N>v;v++){var A=e.length;n.getConvexTrianglePillar(j,v,!1),u.pointToWorldFrame(n.pillarOffset,y),this.sphereConvex(e,f,n.pillarConvex,o,y,i,t,l,u),n.getConvexTrianglePillar(j,v,!0),u.pointToWorldFrame(n.pillarOffset,y),this.sphereConvex(e,f,n.pillarConvex,o,y,i,t,l,u);var C=e.length-A;if(C>2)return}}}},{"../equations/ContactEquation":15,"../math/Quaternion":24,"../math/Vec3":25,"../shapes/ConvexPolyhedron":34,"../shapes/Shape":38,"../solver/Solver":41,"../utils/Vec3Pool":47}],49:[function(e,f){function n(){p.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new d,this.broadphase=null,this.bodies=[],this.solver=new t,this.constraints=[],this.contactgen=new u,this.collisionMatrix=new s,this.collisionMatrixPrevious=new s,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new w,this.defaultMaterial=new c("default"),this.defaultContactMaterial=new y(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}f.exports=n;var o=e("../shapes/Shape"),d=e("../math/Vec3"),i=e("../math/Quaternion"),t=e("../solver/GSSolver"),l=(e("../utils/Vec3Pool"),e("../equations/ContactEquation"),e("../equations/FrictionEquation")),u=e("./ContactGenerator"),p=e("../utils/EventTarget"),s=e("../collision/ArrayCollisionMatrix"),c=e("../material/Material"),y=e("../material/ContactMaterial"),a=e("../objects/RigidBody"),r=e("../objects/Body"),w=e("../utils/TupleDictionary");if(n.prototype=new p,n.prototype.getContactMaterial=function(e,f){return this.contactMaterialTable.get(e.id,f.id)},n.prototype.numObjects=function(){return this.bodies.length},n.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},n.prototype.add=function(e){e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.position.copy(e.initPosition),e.velocity.copy(e.initVelocity),e.timeLastSleepy=this.time,e instanceof a&&(e.angularVelocity.copy(e.initAngularVelocity),e.quaternion.copy(e.initQuaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent)},n.prototype.addConstraint=function(e){this.constraints.push(e)},n.prototype.removeConstraint=function(e){var f=this.constraints.indexOf(e);-1!==f&&this.constraints.splice(f,1)},n.prototype.remove=function(e){e.world=null;var f=this.bodies.length-1,n=this.bodies,o=n.indexOf(e);if(-1!==o){n.splice(o,1);for(var d=0;d!==n.length;d++)n[d].index=d;this.collisionMatrix.setNumObjects(f),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)}},n.prototype.addMaterial=function(e){this.materials.push(e)},n.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var b=Date.now();performance.timing&&performance.timing.navigationStart&&(b=performance.timing.navigationStart),performance.now=function(){return Date.now()-b}}var N=new d;n.prototype.step=function(e,f,n){if(n=n||10,f=f||0,0===f)this.internalStep(e),this.time+=e;else{var o=Math.floor((this.time+f)/e)-Math.floor(this.time/e);o=Math.min(o,n);for(var d=performance.now(),i=0;i!==o&&(this.internalStep(e),!(performance.now()-d>1e3*e));i++);this.time+=f;for(var t=this.time%e,l=t/e,u=N,p=this.bodies,s=0;s!==p.length;s++){var c=p[s];c.type!==r.STATIC&&c.sleepState!==r.SLEEPING?(c.position.vsub(c.previousPosition,u),u.scale(l,u),c.position.vadd(u,c.interpolatedPosition)):(c.position.copy(c.interpolatedPosition),c.quaternion.copy(c.interpolatedQuaternion))}}};var g={type:"postStep"},m={type:"preStep"},x={type:"collide",body:null,contact:null},j=[],v=[],A=[],C=[],O=new d,h=(new d,new d,new d,new d,new d,new d,new d,new d,new i,new i),k=new i,q=new d;n.prototype.internalStep=function(e){if(!(0>=e||isNaN(e))){var f,n=this.contacts,d=A,i=C,t=this.numObjects(),u=this.bodies,p=this.solver,s=this.gravity,c=this.doProfiling,y=this.profile,a=r.DYNAMIC,w=this.constraints,b=v,N=s.norm(),z=s.x,B=s.y,D=s.z,E=0;for(c&&(f=performance.now()),void 0===e&&(e=this.last_dt||this.default_dt),E=0;E!==t;E++){var F=u[E];if(F.type&a){var G=F.force,H=F.mass;G.x+=H*z,G.y+=H*B,G.z+=H*D}}for(var E=0,I=this.subsystems.length;E!==I;E++)this.subsystems[E].update();c&&(f=performance.now()),d.length=0,i.length=0,this.broadphase.collisionPairs(this,d,i),c&&(y.broadphase=performance.now()-f);var J=w.length;for(E=0;E!==J;E++){var K=w[E];if(!K.collideConnected)for(var L=d.length-1;L>=0;L-=1)(K.bodyA===d[L]&&K.bodyB===i[L]||K.bodyB===d[L]&&K.bodyA===i[L])&&(d.splice(L,1),i.splice(L,1))}this.collisionMatrixTick(),c&&(f=performance.now());var M=j,P=n.length;for(E=0;E!==P;E++)M.push(n[E]);n.length=0,this.contactgen.getContacts(d,i,this,n,M),c&&(y.narrowphase=performance.now()-f),c&&(f=performance.now());var Q=n.length,R=this.frictionEquations.length;for(E=0;E!==R;E++)b.push(this.frictionEquations[E]);this.frictionEquations.length=0;for(var S=0;S!==Q;S++){var T,K=n[S],F=K.bi,U=K.bj,E=u.indexOf(F),L=u.indexOf(U);T=F.material&&U.material?this.getContactMaterial(F.material,U.material)||this.defaultContactMaterial:this.defaultContactMaterial;var V=T.friction,W=O;W.set(U.position.x+K.rj.x-F.position.x-K.ri.x,U.position.y+K.rj.y-F.position.y-K.ri.y,U.position.z+K.rj.z-F.position.z-K.ri.z);var X=W.dot(K.ni);if(0>X){if(F.collisionResponse&&U.collisionResponse&&(K.restitution=T.restitution,K.penetration=X,K.setSpookParams(T.contactEquationStiffness,T.contactEquationRelaxation,e),p.addEquation(K),V>0)){var Y=V*N,Z=F.invMass+U.invMass;Z>0&&(Z=1/Z);var $=b,_=$.length?$.pop():new l(F,U,Y*Z),ef=$.length?$.pop():new l(F,U,Y*Z);this.frictionEquations.push(_),this.frictionEquations.push(ef),_.bi=ef.bi=F,_.bj=ef.bj=U,_.minForce=ef.minForce=-Y*Z,_.maxForce=ef.maxForce=Y*Z,K.ri.copy(_.ri),K.rj.copy(_.rj),K.ri.copy(ef.ri),K.rj.copy(ef.rj),K.ni.tangents(_.t,ef.t),_.setSpookParams(T.frictionEquationStiffness,T.frictionEquationRelaxation,e),ef.setSpookParams(T.frictionEquationStiffness,T.frictionEquationRelaxation,e),p.addEquation(_),p.addEquation(ef)}if(F.allowSleep&&F.type===r.DYNAMIC&&F.sleepState===r.SLEEPING&&U.sleepState===r.AWAKE&&U.type!==r.STATIC){var ff=U.velocity.norm2()+U.angularVelocity.norm2(),nf=Math.pow(U.sleepSpeedLimit,2);ff>=2*nf&&(F._wakeUpAfterNarrowphase=!0)}if(U.allowSleep&&U.type===r.DYNAMIC&&U.sleepState===r.SLEEPING&&F.sleepState===r.AWAKE&&F.type!==r.STATIC){var of=F.velocity.norm2()+F.angularVelocity.norm2(),df=Math.pow(F.sleepSpeedLimit,2);of>=2*df&&(U._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(F,U,!0),this.collisionMatrix.get(F,U)!==this.collisionMatrixPrevious.get(F,U)&&(x.body=U,x.contact=K,F.dispatchEvent(x),x.body=F,U.dispatchEvent(x))}}for(c&&(y.makeContactConstraints=performance.now()-f,f=performance.now()),E=0;E!==t;E++){var F=u[E];F._wakeUpAfterNarrowphase&&(F.wakeUp(),F._wakeUpAfterNarrowphase=!1)}var J=w.length;for(E=0;E!==J;E++){var K=w[E];K.update();for(var L=0,tf=K.equations.length;L!==tf;L++){var lf=K.equations[L];p.addEquation(lf)}}p.solve(e,this),c&&(y.solve=performance.now()-f),p.removeAllEquations();var uf=Math.pow;for(E=0;E!==t;E++){var F=u[E];if(F.type&a){var pf=uf(1-F.linearDamping,e),sf=F.velocity;sf.mult(pf,sf);var cf=F.angularVelocity;if(cf){var yf=uf(1-F.angularDamping,e);cf.mult(yf,cf)}}}for(this.dispatchEvent(m),E=0;E!==t;E++){var F=u[E];F.preStep&&F.preStep.call(F)}c&&(f=performance.now());var af=h,rf=k,wf=this.stepnumber,bf=r.DYNAMIC|r.KINEMATIC,Nf=wf%(this.quatNormalizeSkip+1)===0,gf=this.quatNormalizeFast,mf=.5*e,xf=o.types.PLANE,jf=o.types.CONVEXPOLYHEDRON;for(E=0;E!==t;E++){var vf=u[E],Af=vf.shape,Cf=vf.force,Of=vf.tau;if(vf.type&bf&&!vf.isSleeping()){var hf=vf.velocity,kf=vf.angularVelocity,qf=vf.position,zf=vf.quaternion,Bf=vf.invMass,Df=vf.invInertiaWorld;if(hf.x+=Cf.x*Bf*e,hf.y+=Cf.y*Bf*e,hf.z+=Cf.z*Bf*e,vf.angularVelocity&&(Df.vmult(Of,q),q.mult(e,q),q.vadd(kf,kf)),qf.x+=hf.x*e,qf.y+=hf.y*e,qf.z+=hf.z*e,vf.angularVelocity&&(af.set(kf.x,kf.y,kf.z,0),af.mult(zf,rf),zf.x+=mf*rf.x,zf.y+=mf*rf.y,zf.z+=mf*rf.z,zf.w+=mf*rf.w,Nf&&(gf?zf.normalizeFast():zf.normalize())),vf.aabbmin&&(vf.aabbNeedsUpdate=!0),Af)switch(Af.type){case xf:Af.worldNormalNeedsUpdate=!0;break;case jf:Af.worldFaceNormalsNeedsUpdate=!0,Af.worldVerticesNeedsUpdate=!0}vf.updateInertiaWorld&&vf.updateInertiaWorld()}vf.force.set(0,0,0),vf.tau&&vf.tau.set(0,0,0)}for(c&&(y.integrate=performance.now()-f),this.time+=e,this.stepnumber+=1,this.dispatchEvent(g),E=0;E!==t;E++){var F=u[E],Ef=F.postStep;Ef&&Ef.call(F)}if(this.allowSleep)for(E=0;E!==t;E++)u[E].sleepTick(this.time)}}},{"../collision/ArrayCollisionMatrix":4,"../equations/ContactEquation":15,"../equations/FrictionEquation":17,"../material/ContactMaterial":20,"../material/Material":21,"../math/Quaternion":24,"../math/Vec3":25,"../objects/Body":26,"../objects/RigidBody":28,"../shapes/Shape":38,"../solver/GSSolver":40,"../utils/EventTarget":43,"../utils/TupleDictionary":45,"../utils/Vec3Pool":47,"./ContactGenerator":48}]},{},[2])(2)});